<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WC Snack Shack - Premium Food Experience</title>
    <link rel="icon" type="image/png" href="/uploads/favicon-16x16.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #79191b;
            --primary-dark: #5a1315;
            --secondary: #3d3b3a;
            --background: #fafafa;
            --success: #27ae60;
            --bonus: #9b59b6;
            --danger: #e74c3c;
            --text-light: #ffffff;
            --shadow: rgba(121, 25, 27, 0.1);
            --accent-red: #79191b;
            --gradient-primary: linear-gradient(135deg, #79191b, #a62326);
            --gradient-success: linear-gradient(135deg, #27ae60, #2ecc71);
            --gradient-bonus: linear-gradient(135deg, #9b59b6, #8e44ad);
            --brand-orange: #FF8C42;
            --profile-name-color: #FF8C42;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Enhanced Receipt Modal */
        .receipt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 20000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .receipt-modal.active {
            display: flex;
        }

        .receipt-container {
            background: white;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.5s ease;
        }

        .receipt-header {
            background: var(--gradient-primary);
            padding: 30px;
            text-align: center;
            color: white;
            border-radius: 20px 20px 0 0;
        }

        .receipt-logo {
            font-family: 'Bodoni Moda', serif;
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .receipt-success-icon {
            width: 80px;
            height: 80px;
            margin: 20px auto;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s ease infinite;
        }

        .receipt-success-icon::after {
            content: '✓';
            color: var(--success);
            font-size: 48px;
            font-weight: bold;
        }

        .receipt-body {
            padding: 30px;
        }

        .receipt-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px dashed #e0e0e0;
        }

        .receipt-section:last-child {
            border-bottom: none;
        }

        .receipt-section h3 {
            color: var(--primary);
            font-family: 'Bodoni Moda', serif;
            font-size: 20px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
        }

        .receipt-row.total {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--primary);
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .receipt-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 0 0 20px 20px;
        }

        .receipt-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 14px;
        }

        .receipt-btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .receipt-btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .receipt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .receipt-order-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin: 10px 0;
        }

        .receipt-timestamp {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        /* Daily Verse Modal Styles */
        .verse-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease;
        }

        .verse-modal.active {
            display: flex;
        }

        .verse-content {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 45px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 3px solid var(--primary);
            position: relative;
            animation: slideDown 0.6s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .verse-header {
            margin-bottom: 25px;
        }

        .verse-header h2 {
            font-family: 'Bodoni Moda', serif;
            color: var(--primary);
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .verse-date {
            color: var(--secondary);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            opacity: 0.8;
        }

        .verse-text {
            font-family: 'Bodoni Moda', serif;
            font-size: 20px;
            line-height: 1.8;
            color: var(--secondary);
            margin: 25px 0;
            padding: 20px;
            background: rgba(121, 25, 27, 0.05);
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            font-style: italic;
        }

        .verse-reference {
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            color: var(--primary);
            font-weight: 600;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .verse-close {
            margin-top: 30px;
        }

        .verse-close button {
            background: linear-gradient(135deg, var(--primary), #8b1e20);
            color: var(--text-light);
            border: none;
            padding: 14px 35px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(121, 25, 27, 0.3);
        }

        .verse-close button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(121, 25, 27, 0.4);
            background: linear-gradient(135deg, #8b1e20, var(--primary));
        }

        .verse-decoration {
            position: absolute;
            font-size: 60px;
            opacity: 0.1;
            color: var(--primary);
        }

        .verse-decoration.top-left {
            top: 20px;
            left: 20px;
        }

        .verse-decoration.bottom-right {
            bottom: 20px;
            right: 20px;
            transform: rotate(180deg);
        }

        /* CSS Icons */
        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            position: relative;
        }

        .icon-cart::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 12px;
            border: 2px solid currentColor;
            border-radius: 2px;
            top: 2px;
            left: 2px;
        }

        .icon-cart::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: currentColor;
            border-radius: 50%;
            bottom: 1px;
            left: 4px;
            box-shadow: 6px 0 0 currentColor;
        }

        .icon-star::before {
            content: '★';
            color: #ffd700;
            font-size: 16px;
            line-height: 1;
        }

        .icon-menu::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 2px;
            background: currentColor;
            top: 4px;
            left: 1px;
            box-shadow: 0 6px 0 currentColor, 0 12px 0 currentColor;
        }

        .icon-user::before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid currentColor;
            top: 2px;
            left: 5px;
        }

        .icon-user::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 8px;
            border: 2px solid currentColor;
            border-radius: 0 0 8px 8px;
            border-top: none;
            bottom: 2px;
            left: 2px;
        }

        .icon-food::before {
            content: '';
            position: absolute;
            width: 14px;
            height: 10px;
            border: 2px solid currentColor;
            border-radius: 2px;
            top: 5px;
            left: 3px;
        }

        .icon-food::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 2px;
            background: currentColor;
            top: 2px;
            left: 7px;
            border-radius: 1px;
        }

        .icon-bonus::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: linear-gradient(45deg, transparent 35%, var(--bonus) 35%, var(--bonus) 65%, transparent 65%);
            transform: rotate(45deg);
            top: 4px;
            left: 4px;
        }

        .icon-logout::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border: 2px solid currentColor;
            border-right: none;
            top: 5px;
            left: 2px;
        }

        .icon-logout::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 2px;
            background: currentColor;
            top: 9px;
            right: 2px;
        }

        .icon-search::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            border: 2px solid currentColor;
            border-radius: 50%;
            top: 2px;
            left: 2px;
        }

        .icon-search::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 2px;
            background: currentColor;
            transform: rotate(45deg);
            bottom: 3px;
            right: 2px;
        }

        .icon-receipt::before {
            content: '📄';
            font-size: 28px;
        }

        /* Enhanced Typography */
        h1, h2, h3, h4, h5, h6, .logo {
            font-family: 'Bodoni Moda', serif;
            color: var(--primary);
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        

        /* Enhanced Header */
        header {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            box-shadow: 0 5px 20px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--primary);
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.95);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 32px;
            font-weight: 900;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Bodoni Moda', serif;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Enhanced Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--text-light);
            box-shadow: 0 4px 15px rgba(121, 25, 27, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(121, 25, 27, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--gradient-primary);
            color: var(--text-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(121, 25, 27, 0.3);
        }

        .btn-bonus {
            background: var(--gradient-bonus);
            color: var(--text-light);
            animation: pulse 2s ease infinite;
        }

        .btn-bonus:hover {
            transform: scale(1.1);
        }

        .cart-icon {
            position: relative;
            cursor: pointer;
            font-size: 24px;
            color: var(--primary);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            animation: float 4s ease-in-out infinite;
        }

        .cart-icon:hover {
            transform: scale(1.2) rotate(5deg);
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--gradient-primary);
            color: var(--text-light);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
            animation: pulse 1s ease infinite;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 25px;
            border: 2px solid var(--primary);
            box-shadow: 0 2px 10px rgba(121, 25, 27, 0.1);
        }

        .bonus-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            background: var(--gradient-bonus);
            color: var(--text-light);
            box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3);
            animation: pulse 2s ease infinite;
        }

        .level-bronze { background: linear-gradient(135deg, #cd7f32, #b8722c); color: var(--text-light); }
        .level-silver { background: linear-gradient(135deg, #95a5a6, #85969a); color: var(--text-light); }
        .level-gold { background: linear-gradient(135deg, #f1c40f, #e6bb0d); color: var(--secondary); }
        .level-platinum { background: linear-gradient(135deg, #e5e4e2, #d5d4d2); color: var(--secondary); }

        /* Search and Filter Bar */
        .search-filter-bar {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(121, 25, 27, 0.1);
            border: 1px solid rgba(121, 25, 27, 0.1);
            position: relative;
            z-index: 1;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 16px 50px 16px 20px;
            border: 2px solid var(--primary);
            border-radius: 30px;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(121, 25, 27, 0.1);
            transform: translateY(-2px);
        }

        .search-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gradient-primary);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-button:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .category-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .category-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 25px;
            color: var(--primary);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: capitalize;
        }

        .category-btn:hover {
            background: rgba(121, 25, 27, 0.1);
            transform: translateY(-2px);
        }

        .category-btn.active {
            background: var(--gradient-primary);
            color: var(--text-light);
            box-shadow: 0 4px 15px rgba(121, 25, 27, 0.3);
        }

        .results-info {
            text-align: center;
            margin: 20px 0;
            color: var(--secondary);
            font-family: 'Montserrat', sans-serif;
        }

        /* Main Content */
        main {
            margin-top: 40px;
        }

        /* Enhanced Section Styling */
        .section {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px var(--shadow);
            display: none;
            animation: slideInUp 0.5s ease;
            border: 1px solid rgba(121, 25, 27, 0.1);
            position: relative;
            overflow: hidden;
        }

        .section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(121, 25, 27, 0.05) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            font-size: 40px;
            margin-bottom: 30px;
            text-align: center;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Bodoni Moda', serif;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Product Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .product-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px var(--shadow);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            border: 1px solid rgba(121, 25, 27, 0.1);
            display: flex;
            flex-direction: column;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .product-card:hover::before {
            transform: scaleX(1);
        }

        .product-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(121, 25, 27, 0.2);
        }

        .product-card.has-bonus {
            border: 2px solid var(--bonus);
            animation: float 3s ease-in-out infinite;
        }

        .product-card.has-bonus::after {
            content: "BONUS";
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--gradient-bonus);
            color: var(--text-light);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1;
            box-shadow: 0 4px 10px rgba(155, 89, 182, 0.4);
            animation: pulse 1.5s ease infinite;
        }

        .product-image {
            width: 100%;
            height: 220px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--secondary);
            border-bottom: 2px solid rgba(121, 25, 27, 0.1);
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.4s ease;
        }

        .product-card:hover .product-image img {
            transform: scale(1.1);
        }

        .product-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-size: 18px;
            font-weight: 600;
            color: var(--secondary);
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .product-info {
            padding: 25px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-family: 'Bodoni Moda', serif;
        }

        .product-category {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(121, 25, 27, 0.1);
            border-radius: 15px;
            font-size: 12px;
            color: var(--primary);
            margin-bottom: 8px;
            font-family: 'Montserrat', sans-serif;
            text-transform: capitalize;
        }

        .product-description {
            color: var(--secondary);
            margin-bottom: 18px;
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            line-height: 1.5;
            flex: 1;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }

        .price-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .price {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Montserrat', sans-serif;
        }

        .bonus-price {
            font-size: 14px;
            color: var(--bonus);
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }

        .add-to-cart-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }

        .btn-small {
            padding: 10px 18px;
            font-size: 13px;
        }

        .product-card.unavailable {
            opacity: 0.5;
            pointer-events: none;
        }

        .product-card.unavailable .btn-primary {
            background: #ccc;
            cursor: not-allowed;
        }

        .product-card.unavailable .btn {
            cursor: not-allowed;
        }

        /* Bonus Controls */
        .bonus-controls {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border: 2px solid rgba(121, 25, 27, 0.1);
            box-shadow: 0 4px 15px rgba(121, 25, 27, 0.05);
            position: relative;
            z-index: 1;
        }

        .bonus-controls h3 {
            color: var(--primary);
            font-family: 'Bodoni Moda', serif;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .bonus-item-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 12px 0;
            padding: 18px;
            background: var(--background);
            border-radius: 12px;
            box-shadow: 0 3px 10px var(--shadow);
            border: 1px solid rgba(121, 25, 27, 0.1);
            position: relative;
            z-index: 1;
        }

        .bonus-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bonus-toggle input[type="checkbox"] {
            width: auto;
            transform: scale(1.3);
            accent-color: var(--primary);
        }

        .bonus-slider {
            flex: 1;
            margin: 0 15px;
            position: relative;
            z-index: 1;
        }

        .bonus-slider input[type="range"] {
            accent-color: var(--primary);
            width: 100%;
            cursor: pointer;
        }

        .bonus-info {
            min-width: 130px;
            text-align: right;
            font-weight: 600;
            color: var(--bonus);
            font-family: 'Montserrat', sans-serif;
        }

        /* Forms */
        .form-group {
            margin-bottom: 22px;
            position: relative;
            z-index: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary);
            font-family: 'Montserrat', sans-serif;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            position: relative;
            z-index: 1;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(121, 25, 27, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 18px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            margin: 22px 0;
            border: 1px solid rgba(121, 25, 27, 0.1);
            position: relative;
            z-index: 1;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
            transform: scale(1.2);
            accent-color: var(--primary);
        }

        /* Coupon Section */
        .coupon-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border: 2px solid rgba(121, 25, 27, 0.1);
            box-shadow: 0 4px 15px rgba(121, 25, 27, 0.05);
            position: relative;
            z-index: 1;
        }

        .coupon-section h3 {
            color: var(--primary);
            font-family: 'Bodoni Moda', serif;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .coupon-input {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .coupon-input input {
            flex: 1;
            margin-bottom: 0;
            position: relative;
            z-index: 1;
        }

        .coupon-applied {
            background: linear-gradient(135deg, var(--success), #229954);
            color: var(--text-light);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-family: 'Montserrat', sans-serif;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        }

        .coupon-error {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: var(--text-light);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-family: 'Montserrat', sans-serif;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }

        /* Enhanced Cart Items */
        .cart-items {
            margin: 25px 0;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(121, 25, 27, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .cart-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--gradient-primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .cart-item:hover::before {
            transform: scaleY(1);
        }

        .cart-item:hover {
            transform: translateX(10px);
            box-shadow: 0 10px 25px var(--shadow);
        }

        .cart-item.free-item {
            background: var(--gradient-success);
            color: white;
        }

        .cart-item.bonus-item {
            background: linear-gradient(135deg, #e8d5f7, #dcc6f0);
            border-left: 4px solid var(--bonus);
        }

        .cart-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            border: 2px solid rgba(121, 25, 27, 0.1);
            box-shadow: 0 4px 15px rgba(121, 25, 27, 0.05);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
        }

        .summary-row.total {
            font-size: 26px;
            font-weight: 700;
            padding-top: 15px;
            border-top: 2px solid var(--primary);
            color: var(--primary);
            font-family: 'Bodoni Moda', serif;
        }

        .delivery-fee {
            color: var(--success);
        }

        .discount-row {
            color: var(--success);
        }

        .bonus-row {
            color: var(--bonus);
        }

        /* Payment Options */
        .payment-options {
            margin: 25px 0;
            position: relative;
            z-index: 1;
        }

        .payment-options h3 {
            color: var(--primary);
            font-family: 'Bodoni Moda', serif;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            position: relative;
            background: white;
        }

        .payment-option:hover {
            border-color: var(--primary);
            background: rgba(121, 25, 27, 0.05);
            transform: translateX(5px);
        }

        .payment-option.selected {
            border-color: var(--primary);
            background: rgba(121, 25, 27, 0.1);
            box-shadow: 0 4px 15px rgba(121, 25, 27, 0.1);
        }

        .payment-option.bonus-only {
            border-color: var(--bonus);
            background: rgba(155, 89, 182, 0.1);
        }

        .payment-option input[type="radio"] {
            width: auto;
            accent-color: var(--primary);
            transform: scale(1.2);
            cursor: pointer;
            pointer-events: none;
        }
        
        .payment-option label {
            display: none;
        }

        .payment-option.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Card Payment Section */
#card-container {
    display: none !important;
    margin: 20px 0;
    padding: 20px;
    border: 2px solid var(--primary);
    border-radius: 15px;
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    box-shadow: 0 4px 15px rgba(121, 25, 27, 0.1);
}

#card-container.active {
    display: block !important;
}

        #card-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card-row {
            display: flex;
            gap: 15px;
        }

        .card-field {
            flex: 1;
        }

        #card-number, #card-cvv, #card-expiration-date, #card-postal-code {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            background: white;
            min-height: 56px;
        }

        #card-number:focus, #card-cvv:focus, #card-expiration-date:focus, #card-postal-code:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(121, 25, 27, 0.1);
        }

        .card-input-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: 5px;
            font-family: 'Montserrat', sans-serif;
        }

        .payment-processing {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--primary);
            font-weight: 600;
            background: rgba(121, 25, 27, 0.05);
            border-radius: 10px;
            margin: 15px 0;
        }

        .payment-processing.active {
            display: block;
        }

        /* Order Status */
        .order-status {
            display: inline-block;
            padding: 6px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Support Ticket Types */
.order-error { background: #e74c3c; color: white; }
.order-bug { background: #e67e22; color: white; }
.order-question { background: #3498db; color: white; }
.order-feature { background: #2ecc71; color: white; }
.order-other { background: #95a5a6; color: white; }

/* Ticket Priority Badges */
.status-low { background: #95a5a6; color: white; }
.status-medium { background: #f39c12; color: white; }
.status-high { background: #e67e22; color: white; }
.status-critical { background: #e74c3c; color: white; }

/* Ticket Status */
.status-open { background: #3498db; color: white; }
.status-in_progress { background: #f39c12; color: white; }
.status-resolved { background: #27ae60; color: white; }
.status-closed { background: #95a5a6; color: white; }

        .status-pending { background: linear-gradient(135deg, #f39c12, #e67e22); color: var(--text-light); }
        .status-accepted { background: linear-gradient(135deg, #3498db, #2980b9); color: var(--text-light); }
        .status-preparing { background: linear-gradient(135deg, var(--bonus), #8e44ad); color: var(--text-light); }
        .status-delivering { background: linear-gradient(135deg, #e67e22, #d35400); color: var(--text-light); }
        .status-completed { background: linear-gradient(135deg, var(--success), #229954); color: var(--text-light); }
        .status-cancelled { background: linear-gradient(135deg, var(--danger), #c0392b); color: var(--text-light); }

        /* Account Section */
        .profile-card {
            background: linear-gradient(135deg, var(--primary), #8b1e20);
            color: var(--text-light);
            padding: 35px;
            border-radius: 15px;
            margin-bottom: 35px;
            box-shadow: 0 8px 25px rgba(121, 25, 27, 0.3);
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .profile-info h2 {
            font-size: 32px;
            margin-bottom: 8px;
            font-family: 'Bodoni Moda', serif;
        }

        .profile-email {
            opacity: 0.9;
            font-size: 16px;
            font-family: 'Montserrat', sans-serif;
        }

        .rewards-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
        }

        .reward-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .reward-value {
            font-size: 36px;
            font-weight: 700;
            display: block;
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 5px;
        }

        .reward-label {
            font-size: 14px;
            opacity: 0.9;
            font-family: 'Montserrat', sans-serif;
        }

        .order-history {
            margin-top: 35px;
        }

        .order-history h3 {
            color: var(--primary);
            font-family: 'Bodoni Moda', serif;
            font-size: 28px;
            margin-bottom: 20px;
        }

        .order-card {
            background: var(--background);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 18px;
            box-shadow: 0 4px 15px var(--shadow);
            border: 1px solid rgba(121, 25, 27, 0.1);
            transition: all 0.3s ease;
        }

        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .order-header h4 {
            color: var(--primary);
            font-family: 'Bodoni Moda', serif;
            font-size: 20px;
        }

        .order-items {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 18px;
            border-radius: 10px;
            margin: 12px 0;
            border: 1px solid rgba(121, 25, 27, 0.1);
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 18px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--background);
            padding: 35px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid rgba(121, 25, 27, 0.1);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: var(--primary);
            font-family: 'Bodoni Moda', serif;
            font-size: 28px;
        }

        .close-modal {
            font-size: 32px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--primary);
        }

        .error-message {
            color: var(--danger);
            font-size: 14px;
            margin-top: 8px;
            font-family: 'Montserrat', sans-serif;
        }

        .success-message {
            color: var(--success);
            font-size: 14px;
            margin-top: 8px;
            font-family: 'Montserrat', sans-serif;
        }

        /* Loading Spinner Enhanced */
        .loading {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(121, 25, 27, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Notification */
        .notification {
            position: fixed;
            top: 90px;
            right: 25px;
            padding: 20px 35px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            animation: slideInRight 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            backdrop-filter: blur(10px);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.95));
            border: 2px solid;
        }

        .notification.success {
            border-color: var(--success);
            color: var(--success);
        }

        .notification.error {
            border-color: var(--danger);
            color: var(--danger);
        }

        .notification.bonus {
            border-color: var(--bonus);
            color: var(--bonus);
        }

        .notification.warning {
            border-color: #f39c12;
            color: #f39c12;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(150%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Enhanced Footer */
        footer {
            text-align: center;
            padding: 40px;
            color: var(--secondary);
            margin-top: 80px;
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-top: 3px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        footer::before {
    content: '⭐';
    position: absolute;
    font-size: 200px;
    opacity: 0.05;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) rotate(15deg);
    pointer-events: none; /* Добавьте эту строку */
}

        footer a {
            color: var(--primary);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: #8b1e20;
        }

        /* Saved Receipts Button */
        .saved-receipts-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            box-shadow: 0 10px 30px rgba(121, 25, 27, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .saved-receipts-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 15px 40px rgba(121, 25, 27, 0.5);
        }

        .saved-receipts-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Mobile Menu */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--primary);
            font-size: 24px;
            cursor: pointer;
        }

        .mobile-nav {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--background);
            border-top: 1px solid rgba(121, 25, 27, 0.1);
            box-shadow: 0 4px 15px var(--shadow);
        }

        .mobile-nav.active {
            display: block;
        }

        .mobile-nav-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .hidden {
            display: none !important;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--secondary);
        }

        .no-results h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 20px;
            }
            
            .nav-buttons {
                display: none;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .logo {
                font-size: 24px;
                letter-spacing: 1px;
            }

            .rewards-info {
                grid-template-columns: 1fr;
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .bonus-item-controls {
                flex-direction: column;
                gap: 15px;
            }

            .section h2 {
                font-size: 28px;
            }

            .modal-content {
                padding: 25px;
                margin: 20px;
            }

            .cart-item {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .container {
                padding: 10px;
            }

            .section {
                padding: 20px;
            }

            nav {
                padding: 10px 15px;
                position: relative;
            }

            .user-info {
                flex-wrap: wrap;
                gap: 8px;
                padding: 8px 12px;
            }

            .profile-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .coupon-input {
                flex-direction: column;
            }

            .payment-option {
                padding: 12px;
                font-size: 14px;
            }

            .summary-row.total {
                font-size: 22px;
            }

            .category-filters {
                justify-content: center;
            }

            .verse-content {
                padding: 30px 20px;
            }

            .verse-header h2 {
                font-size: 26px;
            }

            .verse-text {
                font-size: 18px;
            }

            .receipt-container {
                width: 95%;
            }
            
            .saved-receipts-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }

            .card-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }

            .product-card {
                max-width: 100%;
            }

            .btn {
                padding: 10px 16px;
                font-size: 12px;
            }

            .section h2 {
                font-size: 24px;
            }

            .logo {
                font-size: 20px;
            }

            .category-btn {
                padding: 8px 16px;
                font-size: 12px;
            }

            .verse-header h2 {
                font-size: 22px;
            }

            .verse-text {
                font-size: 16px;
                padding: 15px;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8b1e20;
        }

        /* Независимый цвет для имени пользователя */
.profile-info h2#profileName {
    background: none !important;
    -webkit-background-clip: unset !important;
    -webkit-text-fill-color: unset !important;
    color: var(--profile-name-color) !important;
}

.warning-text {
    color: red;
}
/* Кнопка наверх */
.scroll-to-top {
      position: fixed;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
    background: var(--gradient-primary);
    color: white;
    border: none;
    font-size: 22px;
    cursor: pointer;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(121, 25, 27, 0.3);
    transition: all 0.3s ease;
}

.scroll-to-top:hover {
    transform: scale(1.1);
}


/* Hover эффекты для кнопок избранного */
.btn.btn-secondary:hover {
    transform: translateY(-1px) scale(1.05);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

/* Стили для кнопки избранных товаров */
.category-btn#favoritesBtn {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border-color: #e74c3c;
}

.category-btn#favoritesBtn:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
}

.category-btn#favoritesBtn.active {
    background: linear-gradient(135deg, #a93226, #922b21);
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
}

/* Анимация сердечка */
.add-to-cart-section .btn-secondary {
    transition: all 0.3s ease;
}

.add-to-cart-section .btn-secondary:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Пульсация для избранных товаров */
.product-card.is-favorite {
    animation: favoriteGlow 2s ease-in-out infinite alternate;
}

@keyframes favoriteGlow {
    0% { box-shadow: 0 10px 30px var(--shadow); }
    100% { box-shadow: 0 10px 30px rgba(231, 76, 60, 0.2); }
}

/* Reviews Styles */
.reviews-summary {
    display: flex;
    align-items: center;
    gap: 30px;
    margin-bottom: 30px;
    padding: 25px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 15px;
    border: 1px solid rgba(121, 25, 27, 0.1);
}

.rating-overview {
    text-align: center;
    min-width: 120px;
}

.average-rating {
    font-size: 48px;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 10px;
}

.rating-breakdown {
    flex: 1;
}

.rating-bar {
    display: flex;
    align-items: center;
    margin: 8px 0;
    gap: 15px;
}

.rating-label {
    font-size: 14px;
    width: 60px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.bar-container {
    flex: 1;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
}

.bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffd700, #ffed4e);
    transition: width 0.5s ease;
}

.bar-count {
    font-size: 12px;
    color: #666;
    min-width: 30px;
}

.add-review-section {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 30px;
    border: 1px solid rgba(121, 25, 27, 0.1);
}

.rating-input-stars {
    margin: 10px 0;
    justify-content: flex-start;
}

.rating-input-stars .star {
    font-size: 28px;
    color: #ddd;
    cursor: pointer;
    transition: all 0.2s ease;
}

.rating-input-stars .star:hover,
.rating-input-stars .star.active {
    color: #ffd700;
    transform: scale(1.1);
}

.review-item {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    transition: all 0.3s ease;
}

.review-item:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.review-user {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--gradient-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
}

.review-info h4 {
    margin: 0 0 5px 0;
    font-size: 16px;
    color: var(--primary);
}

.review-date {
    font-size: 12px;
    color: #666;
}

.verified-badge {
    background: var(--success);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
}

.review-rating {
    display: flex;
    gap: 3px;
    margin-bottom: 10px;
}

.review-comment {
    color: var(--secondary);
    line-height: 1.6;
    margin-bottom: 15px;
}

.review-actions {
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 14px;
}

.helpful-btn {
    background: none;
    border: 1px solid #ddd;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 12px;
}

.helpful-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.helpful-btn.active {
    background: var(--success);
    color: white;
    border-color: var(--success);
}

.review-btn {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.review-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(121, 25, 27, 0.3);
}

.no-reviews {
    text-align: center;
    padding: 40px;
    color: #666;
}

.pagination-btn {
    background: white;
    border: 1px solid #ddd;
    padding: 8px 12px;
    margin: 0 2px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.pagination-btn:hover,
.pagination-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

@media (max-width: 768px) {
    .reviews-summary {
        flex-direction: column;
        text-align: center;
    }
    
    .rating-bar {
        justify-content: center;
    }
    
    .review-header {
        flex-direction: column;
        gap: 10px;
    }
}

/* Error Modal Styles */
.error-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  transition: opacity 0.3s;
}

.error-modal-overlay.show {
  opacity: 1;
}

.error-modal {
  background: white;
  border-radius: 12px;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.error-modal-header {
  padding: 20px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.error-modal-header h3 {
  margin: 0;
  color: #e74c3c;
}

.error-modal-close {
  background: none;
  border: none;
  font-size: 28px;
  cursor: pointer;
  color: #999;
  line-height: 1;
  padding: 0;
  width: 30px;
  height: 30px;
}

.error-modal-close:hover {
  color: #333;
}

.error-modal-body {
  padding: 20px;
}

.error-details-preview {
  background: #f8f9fa;
  padding: 12px;
  border-radius: 6px;
  margin: 15px 0;
  font-size: 13px;
  color: #666;
  border-left: 3px solid #e74c3c;
}

.error-modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}



.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}


/* Floating Support Button - FIXED POSITIONING */
.floating-support-button {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 100;
}   

.floating-support-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.floating-support-button:active {
    transform: scale(0.95);
}

/* View Receipts Button - FIXED */
.scroll-to-top,
.view-receipts-btn {
  position: fixed;
  right: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: var(--gradient-primary);
  color: white;
  border: none;
  font-size: 22px;
  cursor: pointer;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;              /* убрали лишний паддинг */
  box-sizing: border-box;  /* одинаковый расчёт размеров */
}

/* Расположение */
.view-receipts-btn {
  bottom: 20px;
}

.scroll-to-top {
  bottom: 90px;  /* ровно над квитанциями */
}




.view-receipts-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
}

/* Mobile adjustments */
@media (max-width: 768px) {
    .floating-support-button {
    position: fixed;
    bottom: 20px;
    left: 20px; /* вместо right */
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}
    
    .view-receipts-btn {
        bottom: 15px;
        right: 15px;
        padding: 10px 20px;
        font-size: 14px;
    }
}

/* Variation Modal Styles */
.variation-option {
    padding: 15px 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
}

.variation-option:hover {
    border-color: var(--primary);
    background: rgba(121, 25, 27, 0.05);
    transform: translateX(5px);
}

.variation-option.unavailable {
    opacity: 0.5;
    cursor: not-allowed;
}

.variation-option.unavailable:hover {
    transform: none;
    border-color: #e0e0e0;
}

.variation-name {
    font-weight: 600;
    font-size: 16px;
}

.variation-price {
    color: var(--primary);
    font-weight: 700;
}

.variation-unavailable {
    color: #999;
    font-size: 12px;
}

.product-card.has-bonus::after {
            content: "BONUS";
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--gradient-bonus);
            color: var(--text-light);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1;
            box-shadow: 0 4px 10px rgba(155, 89, 182, 0.4);
            animation: pulse 1.5s ease infinite;
        }

        /* Enhanced Discount Styles */
        .discount-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 2;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.5);
            animation: discountPulse 2s ease-in-out infinite;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @keyframes discountPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(231, 76, 60, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(231, 76, 60, 0.7);
            }
        }

        .price-with-discount {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .original-price {
            color: #999;
            text-decoration: line-through;
            font-size: 16px;
            font-weight: 500;
        }

        .discounted-price {
            color: #e74c3c;
            font-size: 28px;
            font-weight: 700;
            font-family: 'Montserrat', sans-serif;
            text-shadow: 0 2px 4px rgba(231, 76, 60, 0.2);
        }

        .product-card.has-discount {
            border: 2px solid #e74c3c;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.2);
        }

        .product-card.has-discount:hover {
            box-shadow: 0 15px 40px rgba(231, 76, 60, 0.3);
        }

        /* Special Deals Styles - Minimalist & Attractive */
.deals-section {
    background: #ffffff;
    border-radius: 24px;
    padding: 50px 40px;
    margin-bottom: 40px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #f0f0f0;
    position: relative;
    overflow: hidden;
}

.deals-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff6b6b, #ff9800, #ffd93d);
}

.deals-section h2 {
    font-size: 36px;
    font-weight: 800;
    text-align: center;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #ff6b6b, #ff9800);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.deals-section > p {
    text-align: center;
    color: #666;
    font-size: 16px;
    margin-bottom: 40px;
    font-weight: 400;
}

.deals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 30px;
    margin-top: 30px;
}

.deal-card {
    background: #ffffff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    border: 1px solid #f0f0f0;
    position: relative;
    display: flex;
    flex-direction: column;
}

.deal-card::before {
    content: 'DEAL';
    position: absolute;
    top: 16px;
    right: 16px;
    background: linear-gradient(135deg, #ff6b6b, #ff5252);
    color: white;
    padding: 6px 14px;
    font-size: 11px;
    font-weight: 700;
    border-radius: 20px;
    letter-spacing: 1px;
    z-index: 2;
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
}

.deal-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
    border-color: #ff9800;
}

.deal-image {
    width: 100%;
    height: 220px;
    background: linear-gradient(135deg, #fff8f0, #ffe8d6);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
}

.deal-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
}

.deal-card:hover .deal-image img {
    transform: scale(1.08);
}

.deal-image:not(:has(img)) {
    font-size: 64px;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
}

.deal-info {
    padding: 24px;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.deal-name {
    font-size: 22px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 10px;
    font-family: 'Bodoni Moda', serif;
    line-height: 1.3;
}

.deal-description {
    color: #666;
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 16px;
}

.deal-products {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 16px;
    margin: 16px 0;
    border: 1px solid #e9ecef;
}

.deal-products h4 {
    font-size: 13px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.deal-products ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.deal-products li {
    padding: 6px 0;
    font-size: 14px;
    color: #555;
    display: flex;
    align-items: center;
    gap: 8px;
}

.deal-products li::before {
    content: '✓';
    color: #ff9800;
    font-weight: bold;
    font-size: 16px;
}

.deal-pricing {
    margin: auto 0 16px 0;
    padding-top: 16px;
    border-top: 1px solid #e9ecef;
}

.deal-original-price {
    font-size: 16px;
    color: #999;
    text-decoration: line-through;
    margin-bottom: 4px;
}

.deal-price {
    font-size: 32px;
    font-weight: 800;
    color: #ff6b6b;
    margin-bottom: 8px;
    font-family: 'Montserrat', sans-serif;
}

.deal-savings {
    display: inline-block;
    background: linear-gradient(135deg, #d4f8e8, #b8f2d4);
    color: #00a86b;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
}

.deal-card .btn-primary {
    background: linear-gradient(135deg, #ff6b6b, #ff5252);
    border: none;
    padding: 14px 24px;
    font-weight: 700;
    font-size: 15px;
    box-shadow: 0 4px 16px rgba(255, 107, 107, 0.3);
    transition: all 0.3s ease;
}

.deal-card .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    background: linear-gradient(135deg, #ff5252, #ff3d3d);
}

/* Deal card entrance animation */
@keyframes dealFadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.deal-card {
    animation: dealFadeIn 0.5s ease-out forwards;
    opacity: 0;
}

.deal-card:nth-child(1) { animation-delay: 0.1s; }
.deal-card:nth-child(2) { animation-delay: 0.2s; }
.deal-card:nth-child(3) { animation-delay: 0.3s; }
.deal-card:nth-child(4) { animation-delay: 0.4s; }
.deal-card:nth-child(5) { animation-delay: 0.5s; }
.deal-card:nth-child(6) { animation-delay: 0.6s; }

/* Hover effect for deal products list */
.deal-products li {
    transition: all 0.2s ease;
}

.deal-products li:hover {
    padding-left: 8px;
    color: #ff9800;
}

/* Pulse animation for deal badge */
@keyframes dealPulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

.deal-card::before {
    animation: dealPulse 2s ease-in-out infinite;
}

/* Shimmer effect on hover */
.deal-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s;
    pointer-events: none;
}

.deal-card:hover::after {
    left: 100%;
}

        /* ✅ ДОБАВИТЬ анимацию для уведомления о доставке */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* Дополнительный стиль для скрытия блока доставки */
        .checkbox-group.hidden {
            display: none !important;
        }

        .promo-sticker {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            z-index: 1000;
            animation: bounce 2s infinite;
        }
        
        .promo-title {
            font-size: 12px;
            font-weight: normal;
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .promo-code {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
            margin: 5px 0;
        }
        
        .promo-description {
            font-size: 11px;
            opacity: 0.85;
            margin-top: 5px;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

    </style>
</head>
<body>
    <!-- Receipt Modal -->
    <div class="receipt-modal" id="receiptModal">
        <div class="receipt-container">
            <div class="receipt-header">
                <div class="receipt-logo">WC Snack Shack</div>
                <div class="receipt-success-icon"></div>
                <h2 style="color: white; font-size: 24px; margin: 10px 0;">Order Confirmed!</h2>
            </div>
            
            <div class="receipt-body">
                <div class="receipt-order-number" id="receiptOrderNumber"></div>
                <div class="receipt-timestamp" id="receiptTimestamp"></div>
                
                <div class="receipt-section">
                    <h3>Customer Information</h3>
                    <div class="receipt-row">
                        <span>Name:</span>
                        <span id="receiptCustomerName"></span>
                    </div>
                    <div class="receipt-row">
                        <span>Phone:</span>
                        <span id="receiptCustomerPhone"></span>
                    </div>
                    <div class="receipt-row">
                        <span>Email:</span>
                        <span id="receiptCustomerEmail"></span>
                    </div>
                </div>
                
                <div class="receipt-section">
                    <h3>Order Items</h3>
                    <div id="receiptItems"></div>
                </div>
                <div class="receipt-section" id="receiptDeliverySection" style="display:none;">
    <h3>Delivery Information</h3>
    <div id="receiptDeliveryInfo"></div>
</div>
                
<div class="receipt-section">
    <h3>Payment Details</h3>
    <div class="receipt-row">
        <span>Subtotal:</span>
        <span id="receiptSubtotal"></span>
    </div>
    <div class="receipt-row" id="receiptDeliveryFeeRow" style="display:none;">
        <span>Delivery Fee (FREE!):</span>
        <span id="receiptDeliveryFee"></span>
    </div>
    <div class="receipt-row" id="receiptDiscountRow" style="display:none;">
        <span>Discount:</span>
        <span id="receiptDiscount"></span>
    </div>
    <div class="receipt-row" id="receiptBonusRow" style="display:none;">
        <span>Bonus Discount:</span>
        <span id="receiptBonusDiscount"></span>
    </div>
    <!-- ДОБАВИТЬ ЭТУ СТРОКУ -->
    <div class="receipt-row" id="receiptServiceFeeRow" style="display:none;">
        <span>Service Fee (3.7%):</span>
        <span id="receiptServiceFee"></span>
    </div>
    <div class="receipt-row total">
        <span>Total Paid:</span>
        <span id="receiptTotal"></span>
    </div>
                    <div class="receipt-row">
                        <span>Payment Method:</span>
                        <span id="receiptPaymentMethod"></span>
                    </div>
                    <div class="receipt-row" id="receiptBonusEarnedRow">
                        <span>Bonus Points Earned:</span>
                        <span id="receiptBonusEarned"></span>
                    </div>
                </div>
                
                <div class="receipt-section" style="text-align: center;">
                    <p style="color: #666; font-size: 14px;">
                        Your order will be ready in approximately 2-6 minutes<br>
                        Thank you for choosing WC Snack Shack!
                    </p>
                </div>
            </div>
            
            <div class="receipt-actions">
                <button class="receipt-btn receipt-btn-secondary" onclick="printReceipt()">
                    🖨️ Print
                </button>
                <button class="receipt-btn receipt-btn-secondary" onclick="downloadReceipt()">
                    📥 Download
                </button>
                <button class="receipt-btn receipt-btn-primary" onclick="closeReceipt()">
                    Continue Shopping
                </button>
            </div>
        </div>
    </div>

    <!-- Saved Receipts Button -->
    <button class="saved-receipts-btn" onclick="viewSavedReceipts()" title="View Saved Receipts">
        <span class="icon-receipt"></span>
        <span class="badge" id="savedReceiptsCount" style="display: none;">0</span>
    </button>

    <!-- Daily Verse Modal -->
    <div class="verse-modal" id="verseModal">
        <div class="verse-content">
            <div class="verse-decoration top-left">"</div>
            <div class="verse-decoration bottom-right">"</div>
            
            <div class="verse-header">
                <h2>Daily Bible Verse</h2>
                <div class="verse-date" id="verseDate"></div>
            </div>
            
            <div class="verse-text" id="verseText">
                <!-- Verse text will be inserted here -->
            </div>
            
            <div class="verse-reference" id="verseReference">
                <!-- Bible reference will be inserted here -->
            </div>
            
            <div class="verse-close">
                <button onclick="closeDailyVerse()">Amen & Continue</button>
            </div>
        </div>
    </div>

    <!-- Support Modal -->
<div class="modal" id="supportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Contact Support</h2>
            <span class="close-modal" onclick="closeSupportModal()">×</span>
        </div>
        
        <form id="supportTicketForm">
            <div class="form-group">
                <label>Type of Issue</label>
                <select id="supportType" required>
                    <option value="error">Error/Problem</option>
                    <option value="bug">Bug Report</option>
                    <option value="question">Question</option>
                    <option value="feature">Feature Request</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Subject *</label>
                <input type="text" id="supportSubject" required maxlength="200" 
                       placeholder="Brief description of the issue">
            </div>
            
            <div class="form-group">
                <label>Description *</label>
                <textarea id="supportDescription" rows="5" required maxlength="2000"
                          placeholder="Please provide details about your issue..."></textarea>
            </div>
            
            <div class="form-group" id="supportEmailField" style="display: none;">
                <label>Email (for non-logged users)</label>
                <input type="email" id="supportEmail" 
                       placeholder="your@email.com">
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                Submit Ticket
            </button>
        </form>
    </div>
</div>


<button class="floating-support-button" onclick="openSupportModal()" title="Contact Support">💬</button>


    <!-- Header -->
    <header>
        <nav>
            <div class="logo">WC Snack Shack</div>
            
            <!-- Desktop Navigation -->
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="showSection('menu')">
                    <span class="icon icon-food"></span> Menu
                </button>
                <button class="btn btn-secondary" onclick="showSection('account')">
                    <span class="icon icon-user"></span> Account
                </button>
                <div class="cart-icon" onclick="showSection('cart')">
                    <span class="icon icon-cart"></span>
                    <span class="cart-count" id="cartCount">0</span>
                </div>
<div id="authButtons">
    <button class="btn btn-primary" onclick="showLogin()">Login</button>
</div>
<div id="registerButtons">
    <button class="btn btn-primary" onclick="showRegister()">Register</button>
</div>
                <div id="userInfo" class="user-info" style="display:none;">
                    <div id="userBonus" class="bonus-badge" style="display:none;">
                        <span class="icon icon-star"></span>
                        <span id="userBonusPoints">0</span>
                    </div>
                    <span id="userName"></span>
                    <button class="btn btn-secondary" onclick="logout()">
                        <span class="icon icon-logout"></span> Logout
                    </button>
                </div>
            </div>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span class="icon icon-menu"></span>
            </button>

            <!-- Mobile Navigation -->
            <div class="mobile-nav" id="mobileNav">
                <div class="mobile-nav-content">
                    <button class="btn btn-secondary" onclick="showSection('menu'); toggleMobileMenu()">
                        <span class="icon icon-food"></span> Menu
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('account'); toggleMobileMenu()">
                        <span class="icon icon-user"></span> Account
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('cart'); toggleMobileMenu()">
                        <span class="icon icon-cart"></span> Cart (<span id="mobileCartCount">0</span>)
                    </button>
                    <div id="mobileAuthButtons">
                        <button class="btn btn-primary" onclick="showLogin(); toggleMobileMenu()">Login</button>
                    </div>
                    <div id="mobileUserInfo" class="user-info" style="display:none;">
                        <div id="mobileUserBonus" class="bonus-badge" style="display:none;">
                            <span class="icon icon-star"></span>
                            <span id="mobileUserBonusPoints">0</span>
                        </div>
                        <span id="mobileUserName"></span>
                        <button class="btn btn-secondary" onclick="logout(); toggleMobileMenu()">
                            <span class="icon icon-logout"></span> Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <main>
            <!-- Menu Section -->
            <div class="section active" id="menu">
                <h2>Menu</h2>
                <div class="section-divider"></div>
                

                    <!-- ДОБАВИТЬ ЭТО - Special Deals Section -->
    <div class="deals-section" id="dealsSection" style="display: none;">
        <h2 style="color: #ff9800; text-align: center; font-size: 36px; margin-bottom: 10px;">
            🔥 Special Deals
        </h2>
        <p style="text-align: center; color: #666; margin-bottom: 20px;">
            Limited time combo offers - Save big!
        </p>
        <div class="deals-grid" id="dealsGrid">
            <!-- Deals will be loaded here -->
        </div>
    </div>
                <!-- Search and Filter Bar -->
                <div class="search-filter-bar">
                    <div class="search-container">
                        <input type="text" class="search-input" id="searchInput" autocomplete="off" name="search_[random]" placeholder="Search for products..." oninput="searchProducts(event)" onkeyup="searchProducts(event)">
                        <button class="search-button" onclick="searchProducts()">
                            <span class="icon icon-search"></span>
                        </button>
                    </div>
                    
                    <div class="category-filters" id="categoryFilters">
                        <button class="category-btn active" onclick="filterByCategory('all')">All</button>
                        <button class="category-btn" onclick="filterByCategory('favorites')" id="favoritesBtn">Favorites (<span id="favoritesCount">0</span>)</button>
                        <button class="category-btn" onclick="filterByCategory('coffee')">Coffee</button>
                        <button class="category-btn" onclick="filterByCategory('energy')">Energy Drinks</button>
                        <button class="category-btn" onclick="filterByCategory('water')">Water</button>
                        <button class="category-btn" onclick="filterByCategory('cocktails')">Cocktails</button>
                        <button class="category-btn" onclick="filterByCategory('snacks')">Snacks</button>
                        <button class="category-btn" onclick="filterByCategory('chips')">Chips</button>
                        <button class="category-btn" onclick="filterByCategory('candy')">Candy</button>
                        <button class="category-btn" onclick="filterByCategory('ice cream')">Ice Cream</button>
                        <button class="category-btn" onclick="filterByCategory('other')">Other</button>
                    </div>
                </div>
                
    <div class="results-info" id="resultsInfo" style="display:none;"></div>
    
    <div class="products-grid" id="productsGrid">
        <div class="loading"></div>
    </div>
</div>

            <!-- Cart Section -->
            <div class="section" id="cart">
                <h2>Your Cart</h2>
                <div class="section-divider"></div>
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be displayed here -->
                </div>

                <!-- Bonus Controls Section -->
                <div class="bonus-controls" id="bonusControls" style="display:none;">
                    <h3>Use Bonus Points <span class="icon icon-star"></span></h3>
                    <p>Available Bonus Points: <strong class="brand-accent" id="availableBonusPoints">0</strong></p>
                    <div id="bonusItemsList">
                        <!-- Bonus controls for each item will be displayed here -->
                    </div>
                    <div class="summary-row bonus-row">
                        <span>Total Bonus Discount:</span>
                        <span>-$<span id="totalBonusDiscount">0.00</span></span>
                    </div>
                    <div class="summary-row bonus-row">
                        <span>Total Bonus Points Used:</span>
                        <span><span id="totalBonusUsed">0</span> <span class="icon icon-star"></span></span>
                    </div>
                </div>

                <!-- Coupon Section -->
                <div class="coupon-section">
                    <h3>Have a coupon? An order with a coupon cannot be delivered only pickup!</h3>
                    <div class="coupon-input">
                        <input type="text" id="couponCode" placeholder="Enter coupon code" style="text-transform: uppercase;">
                        <button class="btn btn-primary" onclick="applyCoupon()">Apply</button>
                    </div>
                    <div id="couponMessage"></div>
                </div>

                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span>$<span id="subtotal">0.00</span></span>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableDelivery" onchange="toggleDelivery()">
                        <label for="enableDelivery" style="margin-bottom: 0;">
                            Add delivery (FREE!)
                        </label>
                    </div>
                    <div class="summary-row delivery-fee" id="deliveryFeeRow" style="display:none;">
                        <span>Delivery Fee (FREE!):</span>
                        <span>$<span id="deliveryFee">0.00</span></span>
                    </div>
                    <div class="summary-row discount-row" id="discountRow" style="display:none;">
                        <span>Discount:</span>
                        <span>-$<span id="discountAmount">0.00</span></span>
                    </div>
                    <div class="summary-row bonus-row" id="bonusDiscountRow" style="display:none;">
                        <span>Bonus Discount:</span>
                        <span>-$<span id="bonusDiscountAmount">0.00</span></span>
                    </div>
<div class="summary-row" id="serviceFeeRow">
    <span>Service Fee (3.7%):</span>
    <span>$<span id="serviceFee">0.00</span></span>
</div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span>$<span id="cartTotal">0.00</span></span>
                    </div>
                    <div class="summary-row" style="font-size: 14px; color: var(--bonus);">
                        <span>Bonus points you'll earn:</span>
                        <span><span id="pointsToEarn">0</span> <span class="icon icon-star"></span></span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="proceedToCheckout()" style="width: 100%; margin-top: 25px;">
                    Proceed to Checkout
                </button>
            </div>

            <!-- Checkout Section -->
            <div class="section" id="checkout">
                <h2>Checkout</h2>
                <div class="section-divider"></div>
                <div class="guest-checkout-option" id="guestOption">
                    <p class="text-muted">You can checkout as a guest or login for order tracking and bonus points</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="continueAsGuest()">Continue as Guest</button>
                        <button class="btn btn-primary" onclick="showLogin()">Login</button>
                    </div>
                </div>
                
                <form id="checkoutForm">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="customerPhone" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="customerEmail" required>
                    </div>
                    
                    <div id="deliverySection" style="display:none;">
                        <h3>Delivery Information (FREE DELIVERY!)</h3>
                        <div class="form-group">
                            <label>Delivery Type *</label>
                            <select id="deliveryType" onchange="toggleDeliveryFields()">
                                <option value="classroom">Classroom Delivery</option>
                                <option value="location">Other Location</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="classroomField">
                            <label>Classroom Number *</label>
                            <input type="text" id="classroomNumber" placeholder="e.g., Room 205">
                        </div>
                        
                        <div class="form-group" id="locationField" style="display:none;">
                            <label>Delivery Location *</label>
                            <textarea id="deliveryLocation" rows="3" placeholder="Enter full address or location details"></textarea>
                        </div>
                    </div>

                    <div class="form-group" id="pickupSection">
                        <h3>Pickup Information</h3>
                        <p class="text-muted">Your order will be ready for pickup in approximately 2-6 minutes.</p>
                        <p><strong class="brand-accent">Pickup Location:</strong> Snack Shack</p>
                    </div>
                    
                    <div class="form-group">
                        <label>Special Instructions</label>
                        <textarea id="specialInstructions" rows="3" placeholder="Any special requests or instructions"></textarea>
                    </div>
                    
                    <!-- Payment Method Selection -->
                    <div class="payment-options" id="paymentOptions">
                        <h3>Payment Method - <span class="warning-text">If you don't see card payment, please refresh the site!</span></h3>
                        
                        
                        <!-- Card Payment Option -->
                        <label class="payment-option" id="cardPaymentOption" onclick="selectPaymentMethod('card')">
                            <input type="radio" name="paymentMethod" value="card">
                            <span>Credit/Debit Card</span>
                        </label>
                        
                        <!-- Card Input Container -->
<div id="card-container">
    <div id="square-payment-section">
        <h3>Pay with Card</h3>
        <div id="card-form-container" style="margin: 20px 0; min-height: 120px; border: 2px solid #ddd; border-radius: 8px; padding: 10px;">
            <!-- Square form will be attached here -->
        </div>
        <div id="payment-loading" style="display: none; text-align: center; color: var(--primary); margin: 15px 0;">
            <div class="loading"></div>
            Processing payment...
        </div>
        <!-- УДАЛИТЬ ЭТУ КНОПКУ:
        <button type="button" class="btn btn-primary payment-button" onclick="processSquarePayment()" style="width: 100%; margin-top: 15px;">
            Pay Now
        </button>
        -->
    </div>
</div>               
                        <!-- Bonus Payment Option -->
                        <label class="payment-option" id="bonusPaymentOption" style="display:none;" onclick="selectPaymentMethod('bonus')">
                            <input type="radio" name="paymentMethod" value="bonus">
                            <span>Bonus Points Only ⭐</span>
                        </label>
                        
                        <!-- Cash Payment Option -->
                        <label class="payment-option selected" id="cashPaymentOption" onclick="selectPaymentMethod('cod')">
                            <input type="radio" name="paymentMethod" value="cod" checked>
                            <span>Payment upon receipt (cash or via terminal)</span>
                        </label>
                    </div>

                    <div class="cart-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span>$<span id="checkoutSubtotal">0.00</span></span>
                        </div>
                        <div class="summary-row delivery-fee" id="checkoutDeliveryRow" style="display:none;">
                            <span>Delivery Fee (FREE!):</span>
                            <span>$<span id="checkoutDeliveryFee">0.00</span></span>
                        </div>
                        <div class="summary-row discount-row" id="checkoutDiscountRow" style="display:none;">
                            <span>Discount:</span>
                            <span>-$<span id="checkoutDiscount">0.00</span></span>
                        </div>
                        <div class="summary-row bonus-row" id="checkoutBonusRow" style="display:none;">
                            <span>Bonus Discount:</span>
                            <span>-$<span id="checkoutBonusDiscount">0.00</span></span>
                        </div>
<div class="summary-row" id="checkoutServiceFeeRow">
    <span>Service Fee (3.7%):</span>
    <span>$<span id="checkoutServiceFee">0.00</span></span>
</div>
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span>$<span id="checkoutTotal">0.00</span></span>
                        </div>
                        <div class="summary-row" style="font-size: 14px; color: var(--bonus);">
                            <span>Bonus points you'll earn:</span>
                            <span><span id="checkoutPointsToEarn">0</span> <span class="icon icon-star"></span></span>
                        </div>
                        <div class="summary-row" style="font-size: 14px; color: var(--bonus);" id="bonusUsageRow">
                            <span>Bonus Points Used:</span>
                            <span><span id="checkoutBonusUsed">0</span> <span class="icon icon-star"></span></span>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 25px;">
                        <span id="submitButtonText">Place Order</span>
                        <span class="loading" style="display:none;" id="submitLoading"></span>
                    </button>
                </form>
            </div>

            <!-- Account Section -->
            <div class="section" id="account">
                <div id="accountContent">
                    <h2>Account</h2>
                    <div class="section-divider"></div>
                    <p class="text-muted">Please login to view your account and earn bonus points</p>
                    <button class="btn btn-primary" onclick="showLogin()" style="margin-top: 20px;">Login</button>
                </div>
                
                <div id="profileContent" style="display:none;">
                    <!-- Profile Card -->
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-info">
                                <h2 id="profileName" class="custom-profile-name">John Doe</h2>
                                <div class="profile-email" id="profileEmail">john@example.com</div>
                            </div>
                            <div class="bonus-badge" id="profileLevel">
                                Bronze Member
                            </div>
                        </div>
                        
                        <div class="rewards-info">
                            <div class="reward-stat">
                                <span class="reward-value" id="profileBonusPoints">0</span>
                                <span class="reward-label">Bonus Points <span class="icon icon-star"></span></span>
                            </div>
                            <div class="reward-stat">
                                <span class="reward-value">$<span id="profileTotalSpent">0.00</span></span>
                                <span class="reward-label">Total Spent</span>
                            </div>
                            <div class="reward-stat">
                                <span class="reward-value" id="profileOrderCount">0</span>
                                <span class="reward-label">Total Orders</span>
                            </div>
                            <div class="reward-stat">
                                <span class="reward-value" id="profileBonusUsed">0</span>
                                <span class="reward-label">Bonus Points Used</span>
                            </div>
                        </div>
                    </div>

                    <!-- Order History -->
                    <div class="order-history">
                        <h3>Order History</h3>
                        <div id="orderHistoryList">
                            <div class="loading"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Login/Register Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Login</h2>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail">
                    <div class="error-message" id="loginError"></div>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword">
                </div>
                <button class="btn btn-primary" onclick="login()" style="width: 100%;" id="loginButton">
                    <span id="loginButtonText">Login</span>
                    <span class="loading" style="display:none;" id="loginLoading"></span>
                </button>
                <p style="text-align: center; margin-top: 15px; color: var(--secondary);">
                    Don't have an account? 
                    <a href="#" onclick="showRegister()" style="color: var(--primary); text-decoration: none;">Register</a>
                </p>
            </div>
            
            <div id="registerForm" style="display:none;">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="registerName">
                    <div class="error-message" id="registerNameError"></div>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail">
                    <div class="error-message" id="registerEmailError"></div>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="registerPassword">
                    <div class="error-message" id="registerPasswordError"></div>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="registerPhone">
                    <div class="error-message" id="registerPhoneError"></div>
                </div>
                <button class="btn btn-primary" onclick="register()" style="width: 100%;" id="registerButton">
                    <span id="registerButtonText">Register</span>
                    <span class="loading" style="display:none;" id="registerLoading"></span>
                </button>
                <p style="text-align: center; margin-top: 15px; color: var(--secondary);">
                    Already have an account? 
                    <a href="#" onclick="showLogin()" style="color: var(--primary); text-decoration: none;">Login</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Reviews Modal -->
<div class="modal" id="reviewsModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="reviewsModalTitle">Product Reviews</h2>
            <span class="close-modal" onclick="closeReviewsModal()">&times;</span>
        </div>
        
        <!-- Reviews Summary -->
        <div class="reviews-summary" id="reviewsSummary">
            <div class="rating-overview">
                <div class="average-rating" id="averageRating">0</div>
                <div class="stars" id="summaryStars"></div>
                <div class="total-reviews" id="totalReviews">0 reviews</div>
            </div>
            <div class="rating-breakdown" id="ratingBreakdown">
                <!-- Rating bars will be inserted here -->
            </div>
        </div>

        <!-- Add Review Form -->
        <div class="add-review-section" id="addReviewSection" style="display: none;">
            <h3>Leave a Review</h3>
            <div class="review-form">
                <div class="rating-input">
                    <label>Your Rating:</label>
                    <div class="stars rating-input-stars" id="ratingInput">
                        <span class="star" data-rating="1">★</span>
                        <span class="star" data-rating="2">★</span>
                        <span class="star" data-rating="3">★</span>
                        <span class="star" data-rating="4">★</span>
                        <span class="star" data-rating="5">★</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Comment (optional):</label>
                    <textarea id="reviewComment" rows="3" maxlength="500" 
                              placeholder="Share your experience with this product..."></textarea>
                </div>
                <div style="text-align: right;">
                    <button class="btn btn-primary" onclick="submitReview()">Submit Review</button>
                </div>
            </div>
        </div>

        <!-- Reviews List -->
        <div class="reviews-list" id="reviewsList">
            <!-- Reviews will be loaded here -->
        </div>
        
        <div class="reviews-pagination" id="reviewsPagination" style="text-align: center; margin-top: 20px;">
            <!-- Pagination will be inserted here -->
        </div>
    </div>
</div>

    <footer>
        <p>&copy; 2025 WC Snack Shack. All rights reserved.</p>
	<p style="font-size: 12px;">Built with questionable skill by Bohdan Stepantsov — world’s best programmer!</p>
        <p class="text-muted" style="font-size: 12px; margin-top: 5px;">Earn 1 bonus point for every $1 spent! <span class="icon icon-star"></span></p>
        <a href="https://wc-snackshack.net/admin.html" style="font-size: 10px; color: var(--secondary); text-decoration: none; margin-top: 10px; display: inline-block;">Snack Shack for Staff</a>
    </footer>




    <!-- Square Web Payments SDK -->
    <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js">


    </script>

    <script>

        

// ============================================
// --- Delivery Access Check ---

async function checkDeliveryAccess() {
    if (!currentUser || !authToken) return;
    
    try {
        const response = await fetch(`${API_URL}/user/delivery-status`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Show notification if user has individual access and hasn't seen it yet
            if (data.showNotification && data.isIndividualAccess) {
                showDeliveryNotification();
                
                // Mark notification as shown
                await fetch(`${API_URL}/user/delivery-notification-shown`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            }
            
            return data.hasDeliveryAccess;
        }
    } catch (error) {
        console.error('Error checking delivery access:', error);
    }
    
    return false;
}

function showDeliveryNotification() {
    const notification = document.createElement('div');
    notification.className = 'delivery-notification';
    notification.innerHTML = `
        <div style="
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 500px;
            text-align: center;
            animation: slideDown 0.5s ease-out;
        ">
            <div style="font-size: 48px; margin-bottom: 10px;">🚚</div>
            <h3 style="margin: 0 0 10px 0; font-size: 24px;">Delivery Enabled!</h3>
            <p style="margin: 0; font-size: 16px; opacity: 0.95;">
                You now have access to delivery service. Enjoy free delivery on your orders!
            </p>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="
                        margin-top: 15px;
                        padding: 10px 30px;
                        background: white;
                        color: #4caf50;
                        border: none;
                        border-radius: 25px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: transform 0.2s;
                    "
                    onmouseover="this.style.transform='scale(1.05)'"
                    onmouseout="this.style.transform='scale(1)'">
                Got it! 🎉
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 10000);
}


// Support Modal Functions
function openSupportModal() {
    const emailField = document.getElementById('supportEmailField');
    if (!currentUser) {
        emailField.style.display = 'block';
        document.getElementById('supportEmail').required = true;
    } else {
        emailField.style.display = 'none';
        document.getElementById('supportEmail').required = false;
    }
    
    document.getElementById('supportModal').classList.add('active');
    document.getElementById('supportTicketForm').reset();
}

function closeSupportModal() {
    document.getElementById('supportModal').classList.remove('active');
}

// Submit Support Ticket
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('supportTicketForm');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            
            try {
                const formData = {
                    subject: document.getElementById('supportSubject').value,
                    description: document.getElementById('supportDescription').value,
                    type: document.getElementById('supportType').value,
                    user: {
                        name: currentUser?.name || 'Anonymous',
                        email: currentUser?.email || document.getElementById('supportEmail')?.value || '',
                        phone: currentUser?.phone || '',
                        userId: currentUser?.id || null
                    }
                };
                
                const response = await fetch(`${API_URL}/support/tickets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('Support ticket created! Ticket #' + data.ticketNumber, 'success');
                    closeSupportModal();
                } else {
                    throw new Error(data.error || 'Failed to create ticket');
                }
            } catch (error) {
                console.error('Support ticket error:', error);
                showNotification('Failed to create support ticket: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    }
});

        // Delete own review
async function deleteMyReview(reviewId) {
    if (!confirm('Are you sure you want to delete your review?')) {
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/reviews/${reviewId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('Review deleted successfully', 'success');
            await loadReviews(currentProductForReview, currentReviewsPage);
        } else {
            showNotification(data.error || 'Failed to delete review', 'error');
        }
    } catch (error) {
        console.error('Error deleting review:', error);
        showNotification('Failed to delete review', 'error');
    }
}

        // Reviews functionality
let currentProductForReview = null;
let selectedRating = 0;
let currentReviewsPage = 1;
let isSubmittingReview = false; 

// Show reviews modal
async function showReviews(productId) {
    currentProductForReview = productId;
    currentReviewsPage = 1;
    selectedRating = 0;
    
    const product = products.find(p => p._id === productId);
    if (!product) return;
    
    document.getElementById('reviewsModalTitle').textContent = `${product.name} - Reviews`;
    document.getElementById('reviewsModal').classList.add('active');
    
    // Show/hide add review section
    const addReviewSection = document.getElementById('addReviewSection');
    if (currentUser) {
        addReviewSection.style.display = 'block';
        resetReviewForm();
    } else {
        addReviewSection.style.display = 'none';
    }
    
    await loadReviews(productId);
}

function closeReviewsModal() {
    document.getElementById('reviewsModal').classList.remove('active');
    currentProductForReview = null;
}

// Load reviews for product
async function loadReviews(productId, page = 1) {
    try {
        const response = await fetch(`${API_URL}/reviews/${productId}?page=${page}&limit=5`);
        const data = await response.json();
        
        if (response.ok) {
            displayReviewsSummary(data.stats);
            displayReviewsList(data.reviews);
            displayReviewsPagination(data.pagination);
        } else {
            console.error('Error loading reviews:', data.error);
        }
    } catch (error) {
        console.error('Error loading reviews:', error);
    }
}

// Добавьте эту переменную в начало скрипта (где другие глобальные переменные)
let productsReviewStats = {};

// Новая функция для загрузки статистики отзывов
async function loadReviewsStats() {
    try {
        console.log('🔄 Loading review stats...');
        const response = await fetch(`${API_URL}/reviews/stats`);
        console.log('Response status:', response.status);
        
        if (response.ok) {
            const stats = await response.json();
            
            console.log('📊 Review stats response:', stats);
            console.log('📊 First stat:', stats[0]);
            console.log('📊 Total products with reviews:', stats.length);
            
            // ✅ ИСПРАВЛЕНО: Явная проверка и заполнение
            if (stats && Array.isArray(stats) && stats.length > 0) {
                stats.forEach(stat => {
                    if (stat.productId) {
                        productsReviewStats[stat.productId] = {
                            averageRating: stat.averageRating || 0,
                            totalReviews: stat.totalReviews || 0
                        };
                        console.log(`✓ Added stats for product ${stat.productId}:`, productsReviewStats[stat.productId]);
                    }
                });
                
                console.log('✅ Review stats loaded:', Object.keys(productsReviewStats).length, 'products');
                console.log('📦 Final productsReviewStats:', productsReviewStats);
            } else {
                console.log('⚠️ No review stats found');
            }
        } else {
            console.error('❌ Failed to load review stats, status:', response.status);
        }
    } catch (error) {
        console.error('❌ Error loading review stats:', error);
    }
}

// Обновите функцию loadProducts:
async function loadProducts() {
    try {
        console.log('Loading products from:', API_URL + '/products');
        const response = await fetch(`${API_URL}/products`);
        if (response.ok) {
            products = await response.json();
            filteredProducts = products;
            console.log('✓ Products loaded:', products.length);
            
            // ✅ ЗАГРУЖАЕМ СТАТИСТИКУ ОТЗЫВОВ
            await loadReviewsStats();
            
            displayProducts();
        } else {
            console.error('Failed to load products, status:', response.status);
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        console.error('Error loading products:', error);
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <h3 style="color: var(--danger); margin-bottom: 15px;">Unable to load menu!</h3>
                <p class="text-muted">Please check your connection and try again.</p>
                <button class="btn btn-primary" onclick="loadProducts()" style="margin-top: 15px;">
                    Try Again
                </button>
            </div>
        `;
    }
}

// Display reviews summary
function displayReviewsSummary(stats) {
    document.getElementById('averageRating').textContent = stats.averageRating.toFixed(1);
    document.getElementById('totalReviews').textContent = `${stats.totalReviews} review${stats.totalReviews !== 1 ? 's' : ''}`;
    
    // Summary stars
    const summaryStars = document.getElementById('summaryStars');
    summaryStars.innerHTML = '';
    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.className = 'star';
        star.classList.toggle('filled', i <= Math.round(stats.averageRating));
        star.textContent = '★';
        summaryStars.appendChild(star);
    }
    
    // Rating breakdown
    const breakdown = document.getElementById('ratingBreakdown');
    breakdown.innerHTML = '';
    
    for (let rating = 5; rating >= 1; rating--) {
        const count = stats.distribution[rating] || 0;
        const percentage = stats.totalReviews > 0 ? (count / stats.totalReviews) * 100 : 0;
        
        const barDiv = document.createElement('div');
        barDiv.className = 'rating-bar';
        barDiv.innerHTML = `
            <div class="rating-label">
                <span>${rating}</span>
                <span class="star filled">★</span>
            </div>
            <div class="bar-container">
                <div class="bar-fill" style="width: ${percentage}%"></div>
            </div>
            <div class="bar-count">${count}</div>
        `;
        breakdown.appendChild(barDiv);
    }
}

// Display reviews list
// Объявить ОДИН РАЗ в начале файла (например, после других функций)
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Display reviews list
function displayReviewsList(reviews) {
    const reviewsList = document.getElementById('reviewsList');
    
    if (reviews.length === 0) {
        reviewsList.innerHTML = `
            <div class="no-reviews">
                <h3>No reviews yet. To leave a review you need to register!</h3>
                <p>Be the first to review this product!</p>
            </div>
        `;
        return;
    }
    
    reviewsList.innerHTML = reviews.map(review => {
        const reviewDate = new Date(review.createdAt).toLocaleDateString();
        const userInitial = escapeHtml(review.user.name.charAt(0).toUpperCase()); // ТОЖЕ экранировать!
        const userName = escapeHtml(review.user.name); // ЭКРАНИРОВАТЬ
        const isHelpful = currentUser && review.helpful.includes(currentUser.id);

        const isMyReview = currentUser && review.user.userId === currentUser.id;
        
        return `
            <div class="review-item">
                <div class="review-header">
                    <div class="review-user">
                        <div class="user-avatar">${userInitial}</div>
                        <div class="review-info">
                            <h4>${userName} ${review.verified ? '<span class="verified-badge">Verified Purchase</span>' : ''}</h4>
                            <div class="review-date">${reviewDate}</div>
                        </div>
                    </div>
                </div>
                
                <div class="review-rating">
                    ${Array.from({length: 5}, (_, i) => 
                        `<span class="star ${i < review.rating ? 'filled' : ''}">★</span>`
                    ).join('')}
                </div>
                
                ${review.comment ? `<div class="review-comment">${escapeHtml(review.comment)}</div>` : ''}
                
                <div class="review-actions">
                    ${currentUser ? `
                        <button class="helpful-btn ${isHelpful ? 'active' : ''}" 
                                onclick="toggleHelpful('${review._id}')">
                            👍 Helpful (${review.helpful.length})
                        </button>
                    ` : `<span class="helpful-count">👍 ${review.helpful.length} helpful</span>`}
                </div>
            </div>
        `;
    }).join('');
}

// Display pagination
function displayReviewsPagination(pagination) {
    const paginationDiv = document.getElementById('reviewsPagination');
    
    if (pagination.pages <= 1) {
        paginationDiv.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    if (pagination.page > 1) {
        paginationHTML += `<button class="pagination-btn" onclick="loadReviewsPage(${pagination.page - 1})">Previous</button>`;
    }
    
    // Page numbers
    for (let i = 1; i <= pagination.pages; i++) {
        paginationHTML += `<button class="pagination-btn ${i === pagination.page ? 'active' : ''}" onclick="loadReviewsPage(${i})">${i}</button>`;
    }
    
    // Next button
    if (pagination.page < pagination.pages) {
        paginationHTML += `<button class="pagination-btn" onclick="loadReviewsPage(${pagination.page + 1})">Next</button>`;
    }
    
    paginationDiv.innerHTML = paginationHTML;
}

// Load specific page
async function loadReviewsPage(page) {
    const reviewsList = document.getElementById('reviewsList');
    reviewsList.innerHTML = '<div class="loading"></div>'; // ДОБАВЛЕНО
    
    currentReviewsPage = page;
    await loadReviews(currentProductForReview, page);
}

// Rating input functionality
document.addEventListener('DOMContentLoaded', () => {
    const ratingStars = document.querySelectorAll('#ratingInput .star');
    
    ratingStars.forEach((star, index) => {
        star.addEventListener('click', () => {
            selectedRating = parseInt(star.dataset.rating);
            updateRatingStars();
        });
        
        star.addEventListener('mouseenter', () => {
            const rating = parseInt(star.dataset.rating);
            ratingStars.forEach((s, i) => {
                s.classList.toggle('active', i < rating);
            });
        });
    });
    
    // Reset on mouse leave
    document.getElementById('ratingInput').addEventListener('mouseleave', updateRatingStars);
});

function updateRatingStars() {
    const ratingStars = document.querySelectorAll('#ratingInput .star');
    ratingStars.forEach((star, index) => {
        star.classList.toggle('active', index < selectedRating);
    });
}

function resetReviewForm() {
    selectedRating = 0;
    document.getElementById('reviewComment').value = '';
    updateRatingStars();
    
    // Убедимся что обработчики установлены правильно
    const ratingInput = document.getElementById('ratingInput');
    if (ratingInput && !ratingInput.dataset.initialized) {
        ratingInput.addEventListener('mouseleave', updateRatingStars);
        ratingInput.dataset.initialized = 'true';
    }
}

// Submit review
async function submitReview() {
    // ДОБАВИТЬ проверку
    if (isSubmittingReview) {
        showNotification('Please wait, submitting review...', 'warning');
        return;
    }
    
    if (!currentUser) {
        showNotification('Please login to leave a review', 'error');
        return;
    }
    
    if (selectedRating === 0) {
        showNotification('Please select a rating', 'error');
        return;
    }
    
    const comment = document.getElementById('reviewComment').value.trim();
    
    isSubmittingReview = true; // ДОБАВИТЬ
    
    try {
        const response = await fetch(`${API_URL}/reviews`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                productId: currentProductForReview,
                rating: selectedRating,
                comment: comment
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification(data.verified ? 'Review added! (Verified Purchase)' : 'Review added!', 'success');
            resetReviewForm();
            await loadReviews(currentProductForReview, 1);
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        console.error('Error submitting review:', error);
        showNotification('Failed to submit review', 'error');
    } finally {
        isSubmittingReview = false; // ДОБАВИТЬ
    }
}

// Toggle helpful
async function toggleHelpful(reviewId) {
    if (!currentUser) {
        showNotification('Please login to mark reviews as helpful', 'error');
        return;
    }
    
    try {
        const response = await fetch(`${API_URL}/reviews/${reviewId}/helpful`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            await loadReviews(currentProductForReview, currentReviewsPage);
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        console.error('Error toggling helpful:', error);
    }
}


function updateFavoritesCount() {
    const count = favorites.length;
    const favoritesCountEl = document.getElementById('favoritesCount');
    if (favoritesCountEl) {
        favoritesCountEl.textContent = count;
    }
    
    const favoritesBtn = document.getElementById('favoritesBtn');
    if (favoritesBtn) {
        favoritesBtn.style.display = count > 0 ? 'inline-block' : 'none';
    }
}

        // Daily Bible Verses
        const bibleVerses = [
            { text: "For God so loved the world that he gave his one and only Son, that whoever believes in him shall not perish but have eternal life.", reference: "John 3:16" },
            { text: "I can do all things through Christ who strengthens me.", reference: "Philippians 4:13" },
            { text: "The Lord is my shepherd; I shall not want.", reference: "Psalm 23:1" },
            { text: "Trust in the Lord with all your heart and lean not on your own understanding.", reference: "Proverbs 3:5" },
            { text: "Be strong and courageous. Do not be afraid; do not be discouraged, for the Lord your God will be with you wherever you go.", reference: "Joshua 1:9" },
            { text: "And we know that in all things God works for the good of those who love him.", reference: "Romans 8:28" },
            { text: "Cast all your anxiety on him because he cares for you.", reference: "1 Peter 5:7" },
            { text: "The Lord is my light and my salvation—whom shall I fear?", reference: "Psalm 27:1" },
            { text: "Love is patient, love is kind. It does not envy, it does not boast, it is not proud.", reference: "1 Corinthians 13:4" },
            { text: "For I know the plans I have for you, declares the Lord, plans to prosper you and not to harm you, plans to give you hope and a future.", reference: "Jeremiah 29:11" },
            { text: "Come to me, all you who are weary and burdened, and I will give you rest.", reference: "Matthew 11:28" },
            { text: "Do not be anxious about anything, but in every situation, by prayer and petition, with thanksgiving, present your requests to God.", reference: "Philippians 4:6" },
            { text: "The Lord is close to the brokenhearted and saves those who are crushed in spirit.", reference: "Psalm 34:18" },
            { text: "But those who hope in the Lord will renew their strength. They will soar on wings like eagles.", reference: "Isaiah 40:31" },
            { text: "Be kind and compassionate to one another, forgiving each other, just as in Christ God forgave you.", reference: "Ephesians 4:32" },
            { text: "Therefore do not worry about tomorrow, for tomorrow will worry about itself.", reference: "Matthew 6:34" },
            { text: "God is our refuge and strength, an ever-present help in trouble.", reference: "Psalm 46:1" },
            { text: "In all your ways acknowledge him, and he will make your paths straight.", reference: "Proverbs 3:6" },
            { text: "The joy of the Lord is your strength.", reference: "Nehemiah 8:10" },
            { text: "Let all that you do be done in love.", reference: "1 Corinthians 16:14" },
            { text: "The Lord will fight for you; you need only to be still.", reference: "Exodus 14:14" },
            { text: "Delight yourself in the Lord, and he will give you the desires of your heart.", reference: "Psalm 37:4" },
            { text: "I have told you these things, so that in me you may have peace. In this world you will have trouble. But take heart! I have overcome the world.", reference: "John 16:33" },
            { text: "Be still, and know that I am God.", reference: "Psalm 46:10" },
            { text: "No weapon formed against you shall prosper.", reference: "Isaiah 54:17" },
            { text: "The name of the Lord is a strong tower; the righteous run to it and are safe.", reference: "Proverbs 18:10" },
            { text: "This is the day the Lord has made; We will rejoice and be glad in it.", reference: "Psalm 118:24" },
            { text: "Faith is the substance of things hoped for, the evidence of things not seen.", reference: "Hebrews 11:1" },
            { text: "Let your light shine before others, that they may see your good deeds and glorify your Father in heaven.", reference: "Matthew 5:16" },
            { text: "With God all things are possible.", reference: "Matthew 19:26" }
        ];

        // Function to show daily verse
        function showDailyVerse() {
            const today = new Date().toDateString();
            const lastShown = localStorage.getItem('lastVerseShown');
            
            // Check if verse was already shown today
            if (lastShown === today) {
                return;
            }
            
            // Get a random verse based on user's unique identifier
            const userSeed = localStorage.getItem('userVerseSeed') || Math.random().toString();
            if (!localStorage.getItem('userVerseSeed')) {
                localStorage.setItem('userVerseSeed', userSeed);
            }
            
            // Generate index based on date and user seed
            const dateHash = today.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            const seedHash = userSeed.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            const verseIndex = (dateHash + seedHash) % bibleVerses.length;
            
            const verse = bibleVerses[verseIndex];
            
            // Set verse content
            document.getElementById('verseText').textContent = verse.text;
            document.getElementById('verseReference').textContent = verse.reference;
            document.getElementById('verseDate').textContent = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Show modal
            document.getElementById('verseModal').classList.add('active');
            
            // Mark as shown for today
            localStorage.setItem('lastVerseShown', today);
        }

        // Function to close daily verse
        function closeDailyVerse() {
            document.getElementById('verseModal').classList.remove('active');
        }

        // Enhanced payment system variables
        let squarePayments = null;
        let card = null;
        let cvv = null;
        let expirationDate = null;
        let postalCode = null;
        let paymentForm = null;
        let squareEnabled = false;
        let isPaymentProcessing = false;
        
        // State variables
        let cart = [];
        let currentUser = null;
        let authToken = null;
        let isDeliveryEnabled = false;
        let products = [];
        let filteredProducts = [];
        let currentCategory = 'all';
        let searchQuery = '';
        let appliedCoupon = null;
        let bonusUsage = {
            items: [],
            totalBonusUsed: 0,
            totalDiscount: 0
        };
        let lastReceipt = null;
        // Favorites functionality
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

function toggleFavorite(productId) {
    const index = favorites.indexOf(productId);
    if (index === -1) {
        favorites.push(productId);
        showNotification('Added to favorites!', 'success');
    } else {
        favorites.splice(index, 1);
        showNotification('Removed from favorites!', 'success');
    }
    localStorage.setItem('favorites', JSON.stringify(favorites));
    
    updateFavoritesCount();
    
    if (currentCategory === 'favorites') {
        applyFilters();
    } else {
        displayProducts();
    }
}

function filterByCategory(category) {
    currentCategory = category;
    
    // Remove active class from all category buttons
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to the clicked button
    event.target.classList.add('active');
    
    // Apply the filters
    applyFilters();
}

function updateFavoritesCount() {
    const count = favorites.length;
    const favoritesCountEl = document.getElementById('favoritesCount');
    if (favoritesCountEl) {
        favoritesCountEl.textContent = count;
    }
    
    // Показать/скрыть кнопку избранного
    const favoritesBtn = document.getElementById('favoritesBtn');
    if (favoritesBtn) {
        favoritesBtn.style.display = count > 0 ? 'inline-block' : 'none';
    }
}

        function getAPIURL() {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://45.10.154.118:3000/api';
            } else {
                return 'https://wc-snackshack.net/api';
            }
        }

        const API_URL = getAPIURL();

const SQUARE_APPLICATION_ID = 'sq0idp-fPJgjM1kSoovS5sOKJUT6A';
const SQUARE_LOCATION_ID = 'LPC07NKEX7K3B'; 


        // Check Square payment settings and initialize
async function checkAndInitializeSquare() {
    try {
        console.log('Starting Square initialization...');
        
        // Убедимся что форма скрыта по умолчанию
        hideSquareForm();
        showSquareLoadingState();
        
        // Сначала ждем загрузки Square SDK
        await waitForSquareSDK();
        
        // Затем инициализируем Square только если еще не инициализирован
        if (!window.squareInitialized) {
            await initializeSquarePayment();
            window.squareInitialized = true;
        }
        
        // Проверяем настройки для показа/скрытия
        const response = await fetch(`${API_URL}/settings/payment`);
        const settings = await response.json();
        
        if (settings.squareEnabled) {
            // НЕ показываем форму автоматически - только делаем опцию доступной
            showSquareOption();
            hideSquareLoadingState();
            
            // ВАЖНО: Убеждаемся что форма скрыта если не выбрана карточная оплата
            const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
            if (!selectedPayment || selectedPayment.value !== 'card') {
                hideSquareForm();
            }
        } else {
            hideSquareOption();
        }
    } catch (error) {
        console.error('Error in Square initialization:', error);
        hideSquareOption();
        hideSquareLoadingState();
        
        // Показываем сообщение пользователю
        showSquareError('Card payments are temporarily unavailable. Please use cash payment or refresh the page.');
    }
}

function showSquareOption() {
    const cardOption = document.getElementById('cardPaymentOption');
    if (cardOption) {
        cardOption.style.display = 'flex';
        cardOption.style.opacity = '1';
        cardOption.style.pointerEvents = 'auto';
        
        // Восстанавливаем нормальный текст
        cardOption.innerHTML = `
            <input type="radio" name="paymentMethod" value="card">
            <span>Credit/Debit Card</span>
        `;
    }
}
function hideSquareOption() {
    const cardOption = document.getElementById('cardPaymentOption');
    if (cardOption) {
        cardOption.style.display = 'none';
    }
    // Убеждаемся что форма тоже скрыта
    hideSquareForm();
}



        // Initialize Square Payment SDK
async function initializeSquarePayment() {
    try {
        console.log('Initializing Square payments...');
        
        const payments = window.Square.payments(SQUARE_APPLICATION_ID, SQUARE_LOCATION_ID);
        
        const card = await payments.card({
            style: {
                '.input-container': {
                    borderColor: '#ddd',
                    borderRadius: '8px'
                },
                '.input-container.is-focus': {
                    borderColor: '#79191b'
                },
                '.input-container.is-error': {
                    borderColor: '#e74c3c'
                },
                '.message-text': {
                    color: '#e74c3c'
                }
            }
        });

        // Проверяем что контейнер существует
        const cardContainer = document.getElementById('card-form-container');
        if (!cardContainer) {
            throw new Error('Card form container not found');
        }
        
        await card.attach('#card-form-container');
        
        window.squareCard = card;
        window.squarePayments = payments;

        console.log('Square payment form initialized successfully');
        
    } catch (error) {
        console.error('Failed to initialize Square payments:', error);
        throw error; // Пробрасываем ошибку выше
    }
}

function waitForSquareSDK(maxAttempts = 20, attempt = 0) {
    return new Promise((resolve, reject) => {
        if (window.Square) {
            console.log('Square SDK loaded successfully');
            resolve();
            return;
        }
        
        if (attempt >= maxAttempts) {
            console.error('Square SDK failed to load after', maxAttempts, 'attempts');
            reject(new Error('Square SDK failed to load'));
            return;
        }
        
        console.log(`Waiting for Square SDK... attempt ${attempt + 1}/${maxAttempts}`);
        
        setTimeout(() => {
            waitForSquareSDK(maxAttempts, attempt + 1).then(resolve).catch(reject);
        }, 1000); // Увеличили интервал до 1 секунды
    });
}


        // Payment method selection handler
function selectPaymentMethod(method) {
    console.log('Selecting payment method:', method);
    
    // Remove selected class from all options
    document.querySelectorAll('.payment-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // ВСЕГДА скрываем форму карты сначала
    const cardContainer = document.getElementById('card-container');
    cardContainer.style.display = 'none';
    cardContainer.classList.remove('active');
    
    // Обновляем текст кнопки
    const submitButtonText = document.getElementById('submitButtonText');
    
    // Show/hide based on selected method
    if (method === 'card' && window.squareInitialized) {
        const cardOption = document.getElementById('cardPaymentOption');
        if (cardOption && cardOption.style.display !== 'none') {
            cardOption.classList.add('selected');
            cardContainer.style.display = 'block';
            cardContainer.classList.add('active');
            submitButtonText.textContent = 'Pay with Card';
        } else {
            // Если Square недоступен, переключаемся на наличные
            console.log('Square not available, switching to cash');
            method = 'cod';
        }
    } else if (method === 'bonus') {
        const bonusOption = document.getElementById('bonusPaymentOption');
        if (bonusOption) {
            bonusOption.classList.add('selected');
        }
        submitButtonText.textContent = 'Pay with Bonus Points';
    }
    
    // Всегда обрабатываем cash/COD как fallback
    if (method === 'cod' || method === 'cash') {
        const cashOption = document.getElementById('cashPaymentOption');
        if (cashOption) {
            cashOption.classList.add('selected');
        }
        submitButtonText.textContent = 'Place Order';
        method = 'cod'; // Нормализуем значение
    }
    
    // Update radio button
    const radio = document.querySelector(`input[name="paymentMethod"][value="${method}"]`);
    if (radio) {
        radio.checked = true;
    } else {
        // Если радио кнопка не найдена, выбираем cash по умолчанию
        const cashRadio = document.querySelector(`input[name="paymentMethod"][value="cod"]`);
        if (cashRadio) {
            cashRadio.checked = true;
            document.getElementById('cashPaymentOption').classList.add('selected');
            submitButtonText.textContent = 'Place Order';
        }
    }
}

// Интегрированная функция для Square платежей
async function processSquarePaymentIntegrated() {
    if (!window.squareCard) {
        throw new Error('Square card form not initialized');
    }

    const tokenResult = await window.squareCard.tokenize();
    
    if (tokenResult.status !== 'OK') {
        const errors = tokenResult.errors || [];
        const errorMessage = errors.map(error => error.message).join(', ') || 'Card validation failed';
        throw new Error(errorMessage);
    }

    const token = tokenResult.token;
    const totals = calculateTotals();
    
    const orderData = {
        customer: {
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value,
            email: document.getElementById('customerEmail').value,
            userId: currentUser?._id || currentUser?.id
        },
items: cart.map(item => ({
    productId: item._id,
    name: item.displayName || item.name,
    price: item.price,
    quantity: item.quantity,
    isFree: item.isFree || false,
    variationName: item.variationName || null,
    fromDeal: item.fromDeal || false,     // ✅ ДОБАВИТЬ
    dealId: item.dealId || null,          // ✅ ДОБАВИТЬ
    dealName: item.dealName || null       // ✅ ДОБАВИТЬ
})),
        bonusUsage: bonusUsage,
        couponCode: appliedCoupon?.code,
        hasDelivery: isDeliveryEnabled,
        delivery: {
            enabled: isDeliveryEnabled,
            type: isDeliveryEnabled ? document.getElementById('deliveryType').value : 'pickup',
            classroom: isDeliveryEnabled && document.getElementById('deliveryType').value === 'classroom' ? 
                document.getElementById('classroomNumber').value : null,
            location: isDeliveryEnabled && document.getElementById('deliveryType').value === 'location' ? 
                document.getElementById('deliveryLocation').value : null,
            instructions: document.getElementById('specialInstructions').value
        },
        paymentToken: token,
        paymentMethod: 'card',
        totals: totals
    };

    console.log('Sending order data:', JSON.stringify(orderData, null, 2)); // Для отладки

    const response = await fetch(`${API_URL}/orders`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
        },
        body: JSON.stringify(orderData)
    });

    const result = await response.json();

    if (!response.ok) {
        throw new Error(result.error || 'Payment failed');
    }

    // Успешная обработка
    showPaymentSuccess(result);
    
    showReceipt({
        orderNumber: result.orderNumber,
        customer: orderData.customer,
        items: cart,
        delivery: orderData.delivery,
        totals: totals,
        paymentMethod: 'card',
        paymentStatus: result.paymentStatus
    });
    
    // Очистка после успешного заказа
    clearOrderData();
}

// Функция для обработки обычных заказов (cash/bonus)
async function processRegularOrder() {
    const totals = calculateTotals();
    const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
    
    const orderData = {
        customer: {
            name: document.getElementById('customerName').value,
            phone: document.getElementById('customerPhone').value,
            email: document.getElementById('customerEmail').value,
            userId: currentUser?._id || currentUser?.id
        },
items: cart.map(item => ({
    productId: item._id,
    name: item.displayName || item.name,
    price: item.price,
    quantity: item.quantity,
    isFree: item.isFree || false,
    variationName: item.variationName || null,
    fromDeal: item.fromDeal || false,     // ✅ ДОБАВИТЬ
    dealId: item.dealId || null,          // ✅ ДОБАВИТЬ
    dealName: item.dealName || null       // ✅ ДОБАВИТЬ
})),
        bonusUsage: bonusUsage,
        couponCode: appliedCoupon?.code,
        hasDelivery: isDeliveryEnabled,
        delivery: {
            enabled: isDeliveryEnabled,
            type: isDeliveryEnabled ? document.getElementById('deliveryType').value : 'pickup',
            classroom: isDeliveryEnabled && document.getElementById('deliveryType').value === 'classroom' ? 
                document.getElementById('classroomNumber').value : null,
            location: isDeliveryEnabled && document.getElementById('deliveryType').value === 'location' ? 
                document.getElementById('deliveryLocation').value : null,
            instructions: document.getElementById('specialInstructions').value
        },
        paymentToken: null,
        paymentMethod: selectedPaymentMethod,
        totals: totals
    };
    
    const response = await fetch(`${API_URL}/orders`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
        },
        body: JSON.stringify(orderData)
    });
    
    const data = await response.json();
    
    if (!response.ok) {
        throw new Error(data.error || 'Order failed');
    }
    
    let message = `Order placed successfully! Order #${data.orderNumber}. `;
    
    if (data.paymentStatus === 'completed') {
        if (data.total === 0) {
            message += 'Paid with bonus points! ';
        }
    } else {
        message += 'Pay on delivery ';
    }
    
    if (data.bonusPointsEarned > 0) {
        message += `You earned ${data.bonusPointsEarned} bonus points! `;
    }
    
    if (data.bonusPointsUsed > 0) {
        message += `Used ${data.bonusPointsUsed} bonus points! `;
    }
    
    showNotification(message, 'success');
    
    showReceipt({
        orderNumber: data.orderNumber,
        customer: orderData.customer,
        items: cart,
        delivery: orderData.delivery,
        totals: totals,
        paymentMethod: selectedPaymentMethod,
        paymentStatus: data.paymentStatus
    });
    
    // Очистка после успешного заказа
    clearOrderData();
}

// Функция очистки данных заказа
function clearOrderData() {
    cart = [];
    appliedCoupon = null;
    bonusUsage = { items: [], totalBonusUsed: 0, totalDiscount: 0 };
    saveCart();
    updateCartUI();
    showSection('menu');
    
    document.getElementById('checkoutForm').reset();
    isDeliveryEnabled = false;
    selectPaymentMethod('cod');
    
    if (currentUser && authToken) {
        checkAuth();
    }
}

        // Process Square payment
async function processSquarePayment() {
    try {
        if (!window.squareCard) {
            throw new Error('Square card form not initialized');
        }

        showLoadingState('Processing payment...');

        const tokenResult = await window.squareCard.tokenize();
        
        if (tokenResult.status === 'OK') {
            const token = tokenResult.token;
            const totals = calculateTotals();
            
            const orderData = {
                customer: {
                    name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value,
                    userId: currentUser?._id || currentUser?.id
                },
items: cart.map(item => ({
    productId: item._id,
    name: item.displayName || item.name, // ✅ Используем displayName
    price: item.price,
    quantity: item.quantity,
    isFree: item.isFree || false,
    variationName: item.variationName || null // ✅ Добавляем вариант
})),

                bonusUsage: bonusUsage,
                couponCode: appliedCoupon?.code,
                hasDelivery: isDeliveryEnabled,
                delivery: {
                    enabled: isDeliveryEnabled,
                    type: isDeliveryEnabled ? document.getElementById('deliveryType').value : 'pickup',
                    classroom: isDeliveryEnabled && document.getElementById('deliveryType').value === 'classroom' ? 
                        document.getElementById('classroomNumber').value : null,
                    location: isDeliveryEnabled && document.getElementById('deliveryType').value === 'location' ? 
                        document.getElementById('deliveryLocation').value : null,
                    instructions: document.getElementById('specialInstructions').value
                },
                paymentToken: token,
                paymentMethod: 'card',
                totals: totals
            };

            const response = await fetch(`${API_URL}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
                },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();

            if (response.ok) {
                showPaymentSuccess(result);
                
                showReceipt({
                    orderNumber: result.orderNumber,
                    customer: orderData.customer,
                    items: cart,
                    delivery: orderData.delivery,
                    totals: totals,
                    paymentMethod: 'card',
                    paymentStatus: result.paymentStatus
                });
                
                cart = [];
                appliedCoupon = null;
                bonusUsage = { items: [], totalBonusUsed: 0, totalDiscount: 0 };
                saveCart();
                updateCartUI();
                showSection('menu');
                
                document.getElementById('checkoutForm').reset();
                isDeliveryEnabled = false;
                
                if (currentUser && authToken) {
                    await checkAuth();
                }
                
            } else {
                throw new Error(result.error || 'Payment failed');
            }

        } else {
            const errors = tokenResult.errors || [];
            const errorMessage = errors.map(error => error.message).join(', ') || 'Card validation failed';
            throw new Error(errorMessage);
        }

    } catch (error) {
        console.error('Payment processing error:', error);
        showPaymentError(error.message);
    } finally {
        hideLoadingState();
    }
}

function showSquareLoadingState() {
    const cardOption = document.getElementById('cardPaymentOption');
    if (cardOption) {
        cardOption.innerHTML = `
            <input type="radio" name="paymentMethod" value="card">
            <span>Credit/Debit Card <span style="font-size: 12px; color: #666;">(Loading...)</span></span>
        `;
        cardOption.style.opacity = '0.7';
    }
}

function hideSquareLoadingState() {
    const cardOption = document.getElementById('cardPaymentOption');
    if (cardOption) {
        cardOption.innerHTML = `
            <input type="radio" name="paymentMethod" value="card">
            <span>Credit/Debit Card</span>
        `;
        cardOption.style.opacity = '1';
    }
}

function showSquareError(message) {
    const cardOption = document.getElementById('cardPaymentOption');
    if (cardOption) {
        cardOption.innerHTML = `
            <input type="radio" name="paymentMethod" value="card" disabled>
            <span style="color: #999;">Credit/Debit Card (Unavailable)</span>
        `;
        cardOption.style.opacity = '0.5';
        cardOption.style.pointerEvents = 'none';
    }
    
    // Показываем уведомление
    setTimeout(() => {
        showNotification(message, 'warning');
    }, 500);
}


function hideSquareForm() {
    const cardContainer = document.getElementById('card-container');
    if (cardContainer) {
        cardContainer.style.display = 'none';
    }
}

function showSquareForm() {
    const cardContainer = document.getElementById('card-container');
    if (cardContainer && window.squareInitialized) {
        cardContainer.style.display = 'block';
        cardContainer.classList.add('active');
    }
}

function showAlternativePaymentMethods() {
    // Показать cash/COD опции
    const cashOption = document.getElementById('cash-payment-option');
    const codOption = document.getElementById('cod-payment-option');
    
    if (cashOption) cashOption.style.display = 'block';
    if (codOption) codOption.style.display = 'block';
}

function showLoadingState(message = 'Processing...') {
    // Показать загрузку
    const loadingElement = document.getElementById('payment-loading');
    if (loadingElement) {
        loadingElement.textContent = message;
        loadingElement.style.display = 'block';
    }
    
    // Отключить кнопки
    const paymentButtons = document.querySelectorAll('.payment-button');
    paymentButtons.forEach(btn => btn.disabled = true);
}

function hideLoadingState() {
    const loadingElement = document.getElementById('payment-loading');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
    
    // Включить кнопки
    const paymentButtons = document.querySelectorAll('.payment-button');
    paymentButtons.forEach(btn => btn.disabled = false);
}

function showPaymentSuccess(result) {
    const message = `Payment successful! Order #${result.orderNumber}`;
    showNotification(message, 'success');
}

function showPaymentError(errorMessage) {
    showNotification(`Payment failed: ${errorMessage}`, 'error');
}

function getCurrentOrderData() {
    // Возвращает текущие данные заказа
    return {
        items: getCartItems(),
        customer: getCustomerData(),
        delivery: getDeliveryData(),
        bonusUsage: getBonusUsage(),
        couponCode: getCouponCode()
    };
}

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            mobileNav.classList.toggle('active');
        }

        // Extract category from product description
        function extractCategory(description) {
    if (!description) return 'other';
    
    const lowerDesc = description.toLowerCase();
    
    if (lowerDesc.includes('coffee') || lowerDesc.includes('кофе')) return 'coffee';
    if (lowerDesc.includes('energy') || lowerDesc.includes('энерг')) return 'energy';
    if (lowerDesc.includes('water') || lowerDesc.includes('вода')) return 'water';
    if (lowerDesc.includes('cocktail') || lowerDesc.includes('коктейль')) return 'cocktails';
    if (lowerDesc.includes('snack') || lowerDesc.includes('снек')) return 'snacks';
    if (lowerDesc.includes('chips') || lowerDesc.includes('чипс')) return 'chips';
    if (lowerDesc.includes('candy') || lowerDesc.includes('конфет') || lowerDesc.includes('сладост')) return 'candy';
    if (lowerDesc.includes('ice cream') || lowerDesc.includes('мороженое') || lowerDesc.includes('ice-cream')) return 'ice cream'; // Добавьте эту строку
    
    return 'other';
}

// Добавьте переменную для debouncing в начало скрипта
let searchTimeout = null;

// Search and filter functions
function searchProducts(event) {
    // Если это событие input (печатание в реальном времени)
    if (event && event.type === 'input') {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchQuery = document.getElementById('searchInput').value.toLowerCase();
            applyFilters();
        }, 300); // 300ms задержка для оптимизации
        return;
    }
    
    // Если это Enter или вызов кнопки поиска
    if (event && event.key && event.key !== 'Enter') {
        return;
    }
    
    // Немедленный поиск для Enter и кнопки
    clearTimeout(searchTimeout); // Отменяем отложенный поиск
    searchQuery = document.getElementById('searchInput').value.toLowerCase();
    applyFilters();
}

function applyFilters() {
    filteredProducts = products.filter(product => {
        const productCategory = extractCategory(product.description);
        let matchesCategory = false;
        
        if (currentCategory === 'all') {
            matchesCategory = true;
        } else if (currentCategory === 'favorites') {
            matchesCategory = favorites.includes(product._id);
        } else {
            matchesCategory = productCategory === currentCategory;
        }
        
        const matchesSearch = searchQuery === '' || 
            product.name.toLowerCase().includes(searchQuery) ||
            (product.description && product.description.toLowerCase().includes(searchQuery));
        
        return matchesCategory && matchesSearch;
    });
    
    displayProducts();
    updateResultsInfo();
}

        function updateResultsInfo() {
            const resultsInfo = document.getElementById('resultsInfo');
            
            if (searchQuery || currentCategory !== 'all') {
                resultsInfo.style.display = 'block';
                let message = `Showing ${filteredProducts.length} product${filteredProducts.length !== 1 ? 's' : ''}`;
                
                if (currentCategory !== 'all') {
                    message += ` in ${currentCategory}`;
                }
                
                if (searchQuery) {
                    message += ` matching "${searchQuery}"`;
                }
                
                resultsInfo.textContent = message;
            } else {
                resultsInfo.style.display = 'none';
            }
        }

        // Authentication functions
        async function checkAuth() {
            authToken = localStorage.getItem('token');
            const savedUser = localStorage.getItem('user');
            
            if (authToken && savedUser) {
                try {
                    const response = await fetch(`${API_URL}/auth/verify`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        currentUser = data.user;
                        updateAuthUI();
                        
                        if (document.getElementById('account').classList.contains('active')) {
                            loadUserProfile();
                        }
                    } else {
                        logout(false);
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                }
            }
        }

async function updateAuthUI() {
    const authButtons = document.getElementById('authButtons');
    const registerButtons = document.getElementById('registerButtons');
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const userBonus = document.getElementById('userBonus');
    const userBonusPoints = document.getElementById('userBonusPoints');

    const mobileAuthButtons = document.getElementById('mobileAuthButtons');
    const mobileRegisterButtons = document.getElementById('mobileRegisterButtons');
    const mobileUserInfo = document.getElementById('mobileUserInfo');
    const mobileUserName = document.getElementById('mobileUserName');
    const mobileUserBonus = document.getElementById('mobileUserBonus');
    const mobileUserBonusPoints = document.getElementById('mobileUserBonusPoints');
    
    if (currentUser) {
        authButtons.style.display = 'none';
        if (registerButtons) registerButtons.style.display = 'none';
        userInfo.style.display = 'flex';
        userName.textContent = currentUser.name;

        mobileAuthButtons.style.display = 'none';
        if (mobileRegisterButtons) mobileRegisterButtons.style.display = 'none';
        mobileUserInfo.style.display = 'flex';
        mobileUserName.textContent = currentUser.name;
        
        if (currentUser.rewards) {
            if (currentUser.rewards.bonusPoints > 0) {
                userBonus.style.display = 'flex';
                userBonusPoints.textContent = currentUser.rewards.bonusPoints;
                mobileUserBonus.style.display = 'flex';
                mobileUserBonusPoints.textContent = currentUser.rewards.bonusPoints;
            }
        }
        
        document.getElementById('accountContent').style.display = 'none';
        document.getElementById('profileContent').style.display = 'block';
        updateProfileDisplay();
        updateBonusControls();
        
        // ✅ ДОБАВИТЬ проверку доступа к доставке
        await checkDeliveryAccess();
    } else {
        authButtons.style.display = 'block';
        if (registerButtons) registerButtons.style.display = 'block';
        userInfo.style.display = 'none';
        userBonus.style.display = 'none';

        mobileAuthButtons.style.display = 'block';
        if (mobileRegisterButtons) mobileRegisterButtons.style.display = 'block';
        mobileUserInfo.style.display = 'none';
        mobileUserBonus.style.display = 'none';

        document.getElementById('accountContent').style.display = 'block';
        document.getElementById('profileContent').style.display = 'none';
        document.getElementById('bonusControls').style.display = 'none';
    }
}

        function updateProfileDisplay() {
            if (!currentUser) return;
            
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            
            if (currentUser.rewards) {
                document.getElementById('profileBonusPoints').textContent = currentUser.rewards.bonusPoints || 0;
                document.getElementById('profileTotalSpent').textContent = (currentUser.rewards.totalSpent || 0).toFixed(2);
                
                const levelBadge = document.getElementById('profileLevel');
                levelBadge.textContent = `${currentUser.rewards.level || 'Bronze'} Member`;
                levelBadge.className = `bonus-badge level-${(currentUser.rewards.level || 'bronze').toLowerCase()}`;
            }
        }

        async function loadUserProfile() {
            if (!authToken) return;
            
            try {
                const response = await fetch(`${API_URL}/user/profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateAuthUI();
                    updateProfileDisplay();
                    
                    document.getElementById('profileOrderCount').textContent = data.stats.totalOrders;
                    document.getElementById('profileBonusUsed').textContent = data.stats.bonusPointsUsed;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Login
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            document.getElementById('loginError').textContent = '';
            
            if (!email || !password) {
                document.getElementById('loginError').textContent = 'Please fill in all fields';
                return;
            }
            
            document.getElementById('loginButtonText').style.display = 'none';
            document.getElementById('loginLoading').style.display = 'inline-block';
            document.getElementById('loginButton').disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('token', authToken);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    closeModal();
                    updateAuthUI();
                    showNotification('Login successful!', 'success');
                    
                    if (document.getElementById('checkout').classList.contains('active')) {
                        fillCheckoutUserData();
                    }
                    
                    if (document.getElementById('account').classList.contains('active')) {
                        loadUserProfile();
                    }
                } else {
                    document.getElementById('loginError').textContent = data.error || 'Login failed';
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Connection error. Please try again.';
            } finally {
                document.getElementById('loginButtonText').style.display = 'inline';
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('loginButton').disabled = false;
            }
        }

        // Register
        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const phone = document.getElementById('registerPhone').value;
            
            document.querySelectorAll('#registerForm .error-message').forEach(el => el.textContent = '');
            
            let hasError = false;
            if (!name) {
                document.getElementById('registerNameError').textContent = 'Name is required';
                hasError = true;
            }
            if (!email) {
                document.getElementById('registerEmailError').textContent = 'Email is required';
                hasError = true;
            }
            if (!password || password.length < 6) {
                document.getElementById('registerPasswordError').textContent = 'Password must be at least 6 characters';
                hasError = true;
            }
            if (!phone) {
                document.getElementById('registerPhoneError').textContent = 'Phone number is required';
                hasError = true;
            }
            
            if (hasError) return;
            
            document.getElementById('registerButtonText').style.display = 'none';
            document.getElementById('registerLoading').style.display = 'inline-block';
            document.getElementById('registerButton').disabled = true;
            
            try {
                const response = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, password, phone })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('token', authToken);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    closeModal();
                    updateAuthUI();
                    showNotification('Registration successful! Welcome to Snack Shack! Start earning bonus points with every purchase!', 'success');
                } else {
                    if (data.error.includes('email')) {
                        document.getElementById('registerEmailError').textContent = data.error;
                    } else {
                        document.getElementById('registerEmailError').textContent = data.error || 'Registration failed';
                    }
                }
            } catch (error) {
                document.getElementById('registerEmailError').textContent = 'Connection error. Please try again.';
            } finally {
                document.getElementById('registerButtonText').style.display = 'inline';
                document.getElementById('registerLoading').style.display = 'none';
                document.getElementById('registerButton').disabled = false;
            }
        }

        // Logout
        function logout(showMessage = true) {
            authToken = null;
            currentUser = null;
            bonusUsage = { items: [], totalBonusUsed: 0, totalDiscount: 0 };
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            updateAuthUI();
            updateCartUI();
            if (showMessage) {
                showNotification('Logged out successfully', 'success');
            }
        }


// Найдите функцию displayProducts() и замените её на эту версию:

function displayProducts() {
    const grid = document.getElementById('productsGrid');
    const productsToDisplay = filteredProducts.length > 0 ? filteredProducts : products;

    if (productsToDisplay.length === 0) {
        if (searchQuery || currentCategory !== 'all') {
            grid.innerHTML = `
                <div class="no-results" style="grid-column: 1 / -1;">
                    <h3>No products found</h3>
                    <p class="text-muted">Try adjusting your search or filter criteria</p>
                    <button class="btn btn-secondary" onclick="resetFilters()">Clear Filters</button>
                </div>
            `;
        } else {
            grid.innerHTML = '<p class="text-muted">No products available at the moment.</p>';
        }
        return;
    }

    grid.innerHTML = productsToDisplay.map(product => {
        const category = extractCategory(product.description);

        let imageContent;
        if (product.image && product.image.startsWith('http')) {
            let imageUrl = product.image;
            if (window.location.protocol === 'https:' && imageUrl.startsWith('http:')) {
                imageUrl = imageUrl.replace('http:', 'https:');
            }
            imageContent = `<img src="${imageUrl}" alt="${product.name}"
                               onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="product-placeholder" style="display: none;">${product.name}</div>`;
        } else {
            imageContent = `<div class="product-placeholder">${product.name}</div>`;
        }

        const hasBonus = product.bonusInfo && product.bonusInfo.hasBonusPrice;
        const hasVariations = product.hasVariations && product.variations && product.variations.length > 0;
        
        const variationsIndicator = hasVariations ? 
            `<div style="background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block; margin-top: 5px;">
                ${product.variations.length} Options Available
            </div>` : '';
        
        const hasDiscount = product.discount && product.discount.enabled && product.discount.percentage > 0;
        const discountBadge = hasDiscount ? 
            `<div class="discount-badge">-${product.discount.percentage}% OFF</div>` : '';
        
        let bonusPriceText = '';
        if (hasBonus) {
            if (product.bonusInfo.allowFullBonusPayment) {
                const pointsNeeded = Math.ceil(product.price * 20);
                bonusPriceText = `<div class="bonus-price">Or ${pointsNeeded} points</div>`;
            } else if (product.bonusInfo.discountPercent) {
                bonusPriceText = `<div class="bonus-price">${product.bonusInfo.discountPercent}% off with ${product.bonusInfo.bonusPointsRequired} points</div>`;
            }
        }

        const unavailableClass = product.available ? '' : ' unavailable';

        // ✅ ОТЗЫВЫ: отображаются только если есть хотя бы один отзыв
let reviewsSection = '';

// Проверяем статистику из отдельного объекта
const reviewStats = productsReviewStats[product._id];

if (reviewStats && reviewStats.averageRating > 0 && reviewStats.totalReviews > 0) {
    const avgRating = reviewStats.averageRating;
    const totalReviews = reviewStats.totalReviews;
    
    // Создаем звезды
    let starsHTML = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= Math.floor(avgRating)) {
            starsHTML += '<span style="color: #ffd700; font-size: 16px;">★</span>';
        } else if (i === Math.ceil(avgRating) && avgRating % 1 >= 0.5) {
            starsHTML += '<span style="color: #ffd700; font-size: 16px;">⯨</span>';
        } else {
            starsHTML += '<span style="color: #ddd; font-size: 16px;">★</span>';
        }
    }
    
    reviewsSection = `
        <div style="display: flex; align-items: center; gap: 8px; margin: 8px 0 12px 0;">
            <div style="display: flex; gap: 2px; align-items: center;">${starsHTML}</div>
            <span style="color: #333; font-weight: 600; font-size: 14px;">${avgRating.toFixed(1)}</span>
            <span style="color: #999; font-size: 13px;">(${totalReviews} ${totalReviews === 1 ? 'review' : 'reviews'})</span>
        </div>
    `;
}

        let finalPrice = product.price;
        let originalPrice = product.price;
        let savingsAmount = 0;

        if (hasDiscount) {
            if (product.discount.originalPrice) {
                originalPrice = product.discount.originalPrice;
            }
            finalPrice = originalPrice * (1 - product.discount.percentage / 100);
            savingsAmount = originalPrice - finalPrice;
        }

        let priceHTML;
        if (hasDiscount) {
            priceHTML = `
                <div class="price-with-discount">
                    <span class="original-price">$${originalPrice.toFixed(2)}</span>
                    <span class="discounted-price">$${finalPrice.toFixed(2)}</span>
                    <span style="color: #27ae60; font-size: 12px; font-weight: 600;">
                        💰 Save -$${savingsAmount.toFixed(2)}
                    </span>
                </div>
            `;
        } else {
            priceHTML = `<span class="price">$${product.price.toFixed(2)}</span>`;
        }

        return `
            <div class="product-card${unavailableClass} ${hasBonus ? 'has-bonus' : ''} ${favorites.includes(product._id) ? 'is-favorite' : ''}">
                ${discountBadge}
                <div class="product-image">
                    ${imageContent}
                </div>
                <div class="product-info">
                    <div class="product-category">${category}</div>
                    <div class="product-name">${product.name}</div>
                    
                    ${reviewsSection}
                    
                    <div class="product-description">
                        ${product.description}
                        ${variationsIndicator}
                    </div>
                    <div class="product-footer">
                        <div class="price-section">
                            ${priceHTML}
                            ${bonusPriceText}
                        </div>
                        <div class="add-to-cart-section">
                            <button class="btn btn-primary btn-small"
                                    onclick="addToCart('${product._id}')"
                                    ${product.available ? '' : 'disabled'}>
                                Add to Cart
                            </button>
                            <button class="btn btn-secondary btn-small" 
                                    onclick="showReviews('${product._id}')">
                                Reviews
                            </button>
                            <button class="btn btn-secondary btn-small" 
                                    onclick="toggleFavorite('${product._id}')" 
                                    style="background: ${favorites.includes(product._id) ? '#e74c3c' : 'transparent'}; color: ${favorites.includes(product._id) ? 'white' : 'var(--primary)'}">
                                ${favorites.includes(product._id) ? '❤️' : '🤍'}
                            </button>
                            ${hasBonus && currentUser && currentUser.rewards.bonusPoints > 0 ?
                                `<button class="btn btn-bonus btn-small"
                                        onclick="addToCartWithBonus('${product._id}')"
                                        ${product.available ? '' : 'disabled'}>
                                    Use Bonus <span class="icon icon-star"></span>
                                </button>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
        

        function resetFilters() {
            currentCategory = 'all';
            searchQuery = '';
            document.getElementById('searchInput').value = '';

            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.category-btn').classList.add('active');

            filteredProducts = products;
            applyFilters();
        }

        // Cart functions
// Обновленная функция addToCart с поддержкой вариантов
function addToCart(productId) {
    const product = products.find(p => p._id === productId);
    if (!product) return;
    
    // Проверяем наличие вариантов
    if (product.hasVariations && product.variations && product.variations.length > 0) {
        showVariationModal(product);
        return;
    }
    
    // Если вариантов нет - добавляем как обычно
    addToCartWithVariation(productId, null);
}

function showVariationModal(product) {
    document.getElementById('variationModalTitle').textContent = `Select ${product.name} Option`;
    
    document.getElementById('variationProductInfo').innerHTML = `
        <div style="padding: 10px;">
            <h3 style="margin: 0; color: var(--primary);">${product.name}</h3>
            <p style="color: #666; font-size: 14px; margin: 5px 0;">Base Price: $${product.price.toFixed(2)}</p>
        </div>
    `;
    
    const availableVariations = product.variations.filter(v => v.available !== false);
    
    if (availableVariations.length === 0) {
        document.getElementById('variationOptions').innerHTML = `
            <p style="text-align: center; color: #666;">No options available at this time</p>
        `;
    } else {
        document.getElementById('variationOptions').innerHTML = availableVariations.map(variation => {
            const finalPrice = product.price + (variation.priceModifier || 0);
            const priceText = variation.priceModifier > 0 ? 
                `+$${variation.priceModifier.toFixed(2)}` : 
                variation.priceModifier < 0 ? 
                `-$${Math.abs(variation.priceModifier).toFixed(2)}` : 
                '';
            
            return `
                <div class="variation-option" onclick="addToCartWithVariation('${product._id}', '${variation.name}')">
                    <div class="variation-name">${variation.name}</div>
                    <div class="variation-price">
                        $${finalPrice.toFixed(2)}
                        ${priceText ? `<span style="font-size: 12px;">(${priceText})</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    document.getElementById('variationModal').classList.add('active');
}

function closeVariationModal() {
    document.getElementById('variationModal').classList.remove('active');
}

function addToCartWithVariation(productId, variationName) {
    const product = products.find(p => p._id === productId);
    if (!product) return;
    
    let finalProduct = { ...product };
    
    // Рассчитываем правильную цену со скидкой
    if (product.discount && product.discount.enabled && product.discount.percentage > 0) {
        const originalPrice = product.discount.originalPrice || product.price;
        finalProduct.price = originalPrice * (1 - product.discount.percentage / 100);
    }
    
    // Если есть вариант - применяем модификатор цены
    if (variationName && product.variations) {
        const variation = product.variations.find(v => v.name === variationName);
        if (variation) {
            finalProduct.price += (variation.priceModifier || 0);
            finalProduct.variationName = variationName;
            finalProduct.displayName = `${product.name} (${variationName})`;
        }
    }
    
    // Создаем уникальный ID для товара с вариантом
    const cartItemId = variationName ? `${productId}_${variationName}` : productId;
    
    const existingItem = cart.find(item => {
        if (variationName) {
            return item._id === productId && item.variationName === variationName;
        }
        return item._id === productId && !item.variationName;
    });
    
    if (existingItem) {
        existingItem.quantity++;
    } else {
        cart.push({ 
            ...finalProduct, 
            quantity: 1,
            cartItemId: cartItemId
        });
    }
    
    saveCart();
    updateCartUI();
    closeVariationModal();
    showNotification(`${finalProduct.displayName || finalProduct.name} added to cart!`, 'success');
}

        function addToCartWithBonus(productId) {
            if (!currentUser) {
                showNotification('Please login to use bonus points', 'error');
                return;
            }
            
            addToCart(productId);
            showNotification('Item added! You can configure bonus usage in your cart.', 'bonus');
        }

// Обновите функцию removeFromCart:
function removeFromCart(productId, variationName = '') {
    cart = cart.filter(item => {
        if (variationName) {
            return !(item._id === productId && item.variationName === variationName);
        }
        return !(item._id === productId && !item.variationName);
    });
    
    bonusUsage.items = bonusUsage.items.filter(item => item.productId !== productId);
    calculateBonusUsage();
    
    saveCart();
    updateCartUI();
}

// Обновите функцию updateQuantity:
function updateQuantity(productId, change, variationName = '') {
    const item = cart.find(item => {
        if (variationName) {
            return item._id === productId && item.variationName === variationName;
        }
        return item._id === productId && !item.variationName;
    });
    
    if (item) {
        item.quantity += change;
        if (item.quantity <= 0) {
            removeFromCart(productId, variationName);
        } else {
            const bonusItem = bonusUsage.items.find(b => b.productId === productId);
            if (bonusItem) {
                updateBonusForItem(productId, bonusItem.bonusUsed);
            }
            
            saveCart();
            updateCartUI();
        }
    }
}

        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            localStorage.setItem('bonusUsage', JSON.stringify(bonusUsage));
        }

        function loadCart() {
            const saved = localStorage.getItem('cart');
            const savedBonus = localStorage.getItem('bonusUsage');
            
            if (saved) {
                cart = JSON.parse(saved);
            }
            
            if (savedBonus) {
                bonusUsage = JSON.parse(savedBonus);
            }
            
            updateCartUI();
        }

        // Bonus System Functions
        function updateBonusControls() {
            const bonusControls = document.getElementById('bonusControls');
            const bonusItemsList = document.getElementById('bonusItemsList');
            const availableBonusPoints = document.getElementById('availableBonusPoints');
            
            if (!currentUser || !currentUser.rewards.bonusPoints || cart.length === 0) {
                bonusControls.style.display = 'none';
                return;
            }
            
            bonusControls.style.display = 'block';
            availableBonusPoints.textContent = currentUser.rewards.bonusPoints;
            
            bonusItemsList.innerHTML = cart.map(item => {
                const product = products.find(p => p._id === item._id);
                if (!product || !product.bonusInfo || !product.bonusInfo.hasBonusPrice) {
                    return '';
                }
                
                const bonusItem = bonusUsage.items.find(b => b.productId === item._id) || 
                    { productId: item._id, bonusUsed: 0, bonusDiscount: 0 };
                
                const maxBonus = calculateMaxBonusForItem(item, product);
                
                return `
                    <div class="bonus-item-controls">
                        <div class="bonus-toggle">
                            <input type="checkbox" id="bonus_${item._id}" 
                                   ${bonusItem.bonusUsed > 0 ? 'checked' : ''} 
                                   onchange="toggleBonusForItem('${item._id}')">
                            <label for="bonus_${item._id}">${item.name} (${item.quantity}x)</label>
                        </div>
                        
                        <div class="bonus-slider">
                            <input type="range" id="bonusSlider_${item._id}" 
                                   min="0" max="${maxBonus}" value="${bonusItem.bonusUsed}"
                                   onchange="updateBonusForItem('${item._id}', this.value)"
                                   ${bonusItem.bonusUsed === 0 ? 'disabled' : ''}>
                        </div>
                        
                        <div class="bonus-info">
                            <div>Using: ${bonusItem.bonusUsed} <span class="icon icon-star"></span></div>
                            <div>Save: ${bonusItem.bonusDiscount.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).filter(Boolean).join('');
        }

        function calculateMaxBonusForItem(cartItem, product) {
            if (!product.bonusInfo || !product.bonusInfo.hasBonusPrice) return 0;
            
            const itemTotal = cartItem.price * cartItem.quantity;
            
            if (product.bonusInfo.allowFullBonusPayment) {
                const maxPointsForFullPayment = Math.ceil(itemTotal * 20);
                return Math.min(maxPointsForFullPayment, currentUser.rewards.bonusPoints);
            } else if (product.bonusInfo.discountPercent && product.bonusInfo.bonusPointsRequired) {
                const maxSets = Math.floor(currentUser.rewards.bonusPoints / product.bonusInfo.bonusPointsRequired);
                return Math.min(product.bonusInfo.bonusPointsRequired * cartItem.quantity, 
                               product.bonusInfo.bonusPointsRequired * maxSets);
            }
            
            return 0;
        }

        function toggleBonusForItem(productId) {
            const checkbox = document.getElementById(`bonus_${productId}`);
            const slider = document.getElementById(`bonusSlider_${productId}`);
            
            if (checkbox.checked) {
                slider.disabled = false;
                const cartItem = cart.find(item => item._id === productId);
                const product = products.find(p => p._id === productId);
                
                const initialBonus = product.bonusInfo.allowFullBonusPayment ? 
                    Math.min(product.bonusInfo.bonusPointsRequired || 20, currentUser.rewards.bonusPoints) : 
                    Math.min(product.bonusInfo.bonusPointsRequired || 0, currentUser.rewards.bonusPoints);
                    
                slider.value = initialBonus * cartItem.quantity;
                updateBonusForItem(productId, slider.value);
            } else {
                slider.disabled = true;
                slider.value = 0;
                updateBonusForItem(productId, 0);
            }
        }

        function updateBonusForItem(productId, bonusPoints) {
            bonusPoints = parseInt(bonusPoints);
            const cartItem = cart.find(item => item._id === productId);
            const product = products.find(p => p._id === productId);
            
            if (!cartItem || !product || !product.bonusInfo || bonusPoints < 0) return;
            
            const currentTotalUsed = bonusUsage.items.reduce((sum, item) => 
                item.productId !== productId ? sum + item.bonusUsed : sum, 0
            );
            const availableForThisItem = currentUser.rewards.bonusPoints - currentTotalUsed;
            
            if (bonusPoints > availableForThisItem) {
                bonusPoints = availableForThisItem;
                document.getElementById(`bonusSlider_${productId}`).value = bonusPoints;
                showNotification(`Only ${availableForThisItem} bonus points available`, 'error');
            }
            
            bonusUsage.items = bonusUsage.items.filter(item => item.productId !== productId);
            
            if (bonusPoints > 0) {
                let bonusDiscount = 0;
                const itemTotal = cartItem.price * cartItem.quantity;
                
                if (product.bonusInfo.allowFullBonusPayment) {
                    bonusDiscount = Math.min(bonusPoints / 20, itemTotal);
                } else if (product.bonusInfo.discountPercent && product.bonusInfo.bonusPointsRequired) {
                    const setsOfDiscount = Math.floor(bonusPoints / product.bonusInfo.bonusPointsRequired);
                    bonusDiscount = Math.min(
                        (itemTotal * product.bonusInfo.discountPercent / 100) * setsOfDiscount,
                        itemTotal
                    );
                }
                
                bonusUsage.items.push({
                    productId: productId,
                    bonusUsed: bonusPoints,
                    bonusDiscount: bonusDiscount
                });
            }
            
            calculateBonusUsage();
            saveCart();
            updateCartUI();
        }

        function calculateBonusUsage() {
            bonusUsage.totalBonusUsed = bonusUsage.items.reduce((sum, item) => sum + item.bonusUsed, 0);
            bonusUsage.totalDiscount = bonusUsage.items.reduce((sum, item) => sum + item.bonusDiscount, 0);
            
            document.getElementById('totalBonusDiscount').textContent = bonusUsage.totalDiscount.toFixed(2);
            document.getElementById('totalBonusUsed').textContent = bonusUsage.totalBonusUsed;
        }

//  ОДНА функция applyCoupon
async function applyCoupon(code) {
    const couponCode = (code || document.getElementById('couponCode').value).trim();
    const messageDiv = document.getElementById('couponMessage');

    if (!couponCode) {
        messageDiv.innerHTML = '<div class="coupon-error">Please enter a coupon code</div>';
        return;
    }

    //  Проверка: купон уже применён
    if (appliedCoupon && appliedCoupon.code === couponCode.toUpperCase()) {
        showNotification('This coupon has already been applied.', 'error');
        return;
    }

    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    try {
        const response = await fetch(`${API_URL}/coupons/validate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                code: couponCode,
                orderTotal: subtotal,
                userId: currentUser?._id || currentUser?.id
            })
        });

        const data = await response.json();

        if (response.ok && data.valid) {
            appliedCoupon = data.coupon;

            if (appliedCoupon.type === 'free_item' && appliedCoupon.freeItem) {
                const freeItem = {
                    ...appliedCoupon.freeItem,
                    quantity: 1,
                    price: 0,
                    isFree: true
                };
                cart.push(freeItem);
                saveCart();
            }

            updateCartUI();

            let message = `Coupon "${appliedCoupon.code}" applied! `;
            switch (appliedCoupon.type) {
                case 'discount_percent':
                    message += `${appliedCoupon.value}% discount`;
                    break;
                case 'discount_fixed':
                    message += `${appliedCoupon.value} discount`;
                    break;
                case 'free_delivery':
                    message += 'Free delivery';
                    break;
                case 'free_item':
                    message += `Free ${appliedCoupon.freeItem.name}`;
                    break;
                    case 'deals':
    loadDeals();
    break;
            }

            messageDiv.innerHTML = `<div class="coupon-applied">${message}</div>`;
            document.getElementById('couponCode').disabled = true;
        } else {
            messageDiv.innerHTML = `<div class="coupon-error">${data.error}</div>`;
        }
    } catch (error) {
        messageDiv.innerHTML = '<div class="coupon-error">Error validating coupon</div>';
    }
}


function calculateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    let deliveryFee = 0;
    let discount = 0;
    const bonusDiscount = bonusUsage.totalDiscount;
    
    if (appliedCoupon) {
        switch (appliedCoupon.type) {
            case 'discount_percent':
                discount = subtotal * (appliedCoupon.value / 100);
                break;
            case 'discount_fixed':
                discount = Math.min(appliedCoupon.value, subtotal);
                break;
            case 'free_delivery':
                break;
        }
    }
    
    // Добавить расчет комиссии
    const SERVICE_FEE_PERCENT = 3.7;
    const preServiceFeeTotal = Math.max(0, subtotal + deliveryFee - discount - bonusDiscount);
    const serviceFee = preServiceFeeTotal * (SERVICE_FEE_PERCENT / 100);
    const total = preServiceFeeTotal + serviceFee;
    
    const bonusPointsToEarn = Math.floor(preServiceFeeTotal); // Без комиссии
    
    return { 
        subtotal, 
        deliveryFee, 
        discount, 
        bonusDiscount,
        serviceFee,
        total, 
        bonusPointsToEarn,
        bonusPointsUsed: bonusUsage.totalBonusUsed
    };
}

function updateCartUI() {
    const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('cartCount').textContent = cartCount;
    document.getElementById('mobileCartCount').textContent = cartCount;
    
    const cartItems = document.getElementById('cartItems');
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-muted">Your cart is empty</p>';
    } else {
cartItems.innerHTML = cart.map(item => {
    const bonusItem = bonusUsage.items.find(b => b.productId === item._id);
    const bonusText = bonusItem ? ` (${bonusItem.bonusUsed} points used, -$${bonusItem.bonusDiscount.toFixed(2)})` : '';
    const itemClass = item.isFree ? 'free-item' : (bonusItem && bonusItem.bonusUsed > 0 ? 'bonus-item' : '');
    
    const displayName = item.displayName || item.name;
    
    // ✅ ДОБАВИТЬ ИНДИКАТОР ДИЛА
    const dealBadge = item.fromDeal ? 
        `<span style="background: #ff9800; color: white; padding: 3px 8px; border-radius: 10px; font-size: 11px; margin-left: 5px;">
            🔥 ${item.dealName}
        </span>` : '';
    
    return `
        <div class="cart-item ${itemClass}">
            <div>
                <strong>${displayName}</strong>
                ${dealBadge}
                ${item.isFree ? '<span style="color: var(--success); font-weight: bold;"> (FREE)</span>' : ''}
                ${bonusText ? `<span style="color: var(--bonus); font-weight: bold;">${bonusText}</span>` : ''}
                <br>
                <span class="text-muted">$${item.price.toFixed(2)} each</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                ${!item.isFree ? `<button class="btn btn-secondary" style="padding: 5px 10px;" onclick="updateQuantity('${item._id}', -1, '${item.variationName || ''}')">-</button>` : ''}
                <span style="min-width: 20px; text-align: center;">${item.quantity}</span>
                ${!item.isFree ? `<button class="btn btn-secondary" style="padding: 5px 10px;" onclick="updateQuantity('${item._id}', 1, '${item.variationName || ''}')">+</button>` : ''}
                <span style="margin-left: 15px; font-weight: 600;">$${((item.price * item.quantity) - (bonusItem ? bonusItem.bonusDiscount : 0)).toFixed(2)}</span>
                <button class="btn btn-secondary" style="padding: 5px 10px; margin-left: 10px;" onclick="removeFromCart('${item._id}', '${item.variationName || ''}')">X</button>
            </div>
        </div>
    `;
}).join('');
    }
    
    const totals = calculateTotals();
    
    document.getElementById('subtotal').textContent = totals.subtotal.toFixed(2);
    document.getElementById('deliveryFee').textContent = totals.deliveryFee.toFixed(2);
    document.getElementById('discountAmount').textContent = totals.discount.toFixed(2);
    document.getElementById('bonusDiscountAmount').textContent = totals.bonusDiscount.toFixed(2);
    document.getElementById('serviceFee').textContent = totals.serviceFee.toFixed(2);
    document.getElementById('cartTotal').textContent = totals.total.toFixed(2);
    document.getElementById('pointsToEarn').textContent = totals.bonusPointsToEarn;
    
    document.getElementById('discountRow').style.display = totals.discount > 0 ? 'flex' : 'none';
    document.getElementById('bonusDiscountRow').style.display = totals.bonusDiscount > 0 ? 'flex' : 'none';
    document.getElementById('serviceFeeRow').style.display = cart.length > 0 ? 'flex' : 'none';
    
    updateCheckoutTotals(totals);
    updateBonusControls();
    updatePaymentOptions(totals);
}

function updateCheckoutTotals(totals) {
    if (document.getElementById('checkoutSubtotal')) {
        document.getElementById('checkoutSubtotal').textContent = totals.subtotal.toFixed(2);
        document.getElementById('checkoutDeliveryFee').textContent = totals.deliveryFee.toFixed(2);
        document.getElementById('checkoutDiscount').textContent = totals.discount.toFixed(2);
        document.getElementById('checkoutBonusDiscount').textContent = totals.bonusDiscount.toFixed(2);
        document.getElementById('checkoutServiceFee').textContent = totals.serviceFee.toFixed(2); // Добавить эту строку
        document.getElementById('checkoutTotal').textContent = totals.total.toFixed(2);
        document.getElementById('checkoutPointsToEarn').textContent = totals.bonusPointsToEarn;
        document.getElementById('checkoutBonusUsed').textContent = totals.bonusPointsUsed;
        
        document.getElementById('checkoutDiscountRow').style.display = totals.discount > 0 ? 'flex' : 'none';
        document.getElementById('checkoutBonusRow').style.display = totals.bonusDiscount > 0 ? 'flex' : 'none';
        document.getElementById('checkoutServiceFeeRow').style.display = 'flex'; // Добавить эту строку
        document.getElementById('bonusUsageRow').style.display = totals.bonusPointsUsed > 0 ? 'flex' : 'none';
    }
}

        // Update payment options based on totals
        function updatePaymentOptions(totals) {
            const cardPaymentOption = document.getElementById('cardPaymentOption');
            const bonusPaymentOption = document.getElementById('bonusPaymentOption');
            const cashPaymentOption = document.getElementById('cashPaymentOption');

            if (totals.total <= 0.01) {
                if (bonusPaymentOption) {
                    bonusPaymentOption.style.display = 'flex';
                    bonusPaymentOption.classList.add('bonus-only');
                    selectPaymentMethod('bonus');
                }
                if (cashPaymentOption) {
                    cashPaymentOption.style.display = 'none';
                }
                if (cardPaymentOption) {
                    cardPaymentOption.style.display = 'none';
                }
            } else {
                if (bonusPaymentOption) {
                    bonusPaymentOption.style.display = 'none';
                    bonusPaymentOption.classList.remove('bonus-only');
                }
                if (cashPaymentOption) {
                    cashPaymentOption.style.display = 'flex';
                }
                if (cardPaymentOption && squareEnabled) {
                    cardPaymentOption.style.display = 'flex';
                }
                
                selectPaymentMethod('cod');
            }
        }

        // Delivery toggle
async function toggleDelivery() {
    isDeliveryEnabled = document.getElementById('enableDelivery').checked;
    
    // Check if user has delivery access
    const hasAccess = await checkDeliveryAccess();
    
    if (isDeliveryEnabled && !hasAccess) {
        // Check global delivery settings
        try {
            const response = await fetch(`${API_URL}/public/delivery`);
            const data = await response.json();
            
            if (!data.deliveryEnabled) {
                showNotification('Delivery is currently unavailable', 'error');
                document.getElementById('enableDelivery').checked = false;
                isDeliveryEnabled = false;
                return;
            }
        } catch (error) {
            console.error('Error checking delivery availability:', error);
        }
    }
    
    document.getElementById('deliveryFeeRow').style.display = isDeliveryEnabled ? 'flex' : 'none';
    
    if (isDeliveryEnabled) {
        document.getElementById('deliverySection').style.display = 'block';
        document.getElementById('pickupSection').style.display = 'none';
        document.getElementById('checkoutDeliveryRow').style.display = 'flex';
    } else {
        document.getElementById('deliverySection').style.display = 'none';
        document.getElementById('pickupSection').style.display = 'block';
        document.getElementById('checkoutDeliveryRow').style.display = 'none';
    }
    
    updateCartUI();
}

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            if (sectionId === 'account' && currentUser) {
                loadUserProfile();
                loadOrderHistory();
            }
        }

        // Modal functions
        function showLogin() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('modalTitle').textContent = 'Login';
            
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').textContent = '';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('modalTitle').textContent = 'Register';
            document.getElementById('loginModal').classList.add('active');
            
            document.getElementById('registerName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerPhone').value = '';
            document.querySelectorAll('#registerForm .error-message').forEach(el => el.textContent = '');
        }

        function closeModal() {
            document.getElementById('loginModal').classList.remove('active');
        }

        // Load order history
        async function loadOrderHistory() {
    if (!authToken) return;
    
    const ordersList = document.getElementById('orderHistoryList');
    ordersList.innerHTML = '<div class="loading"></div>';
    
    try {
        const response = await fetch(`${API_URL}/orders/my-orders`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const orders = await response.json();
            
            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="text-muted">No orders yet</p>';
            } else {
                ordersList.innerHTML = orders.map(order => {
                    const orderDate = new Date(order.createdAt).toLocaleDateString();
                    const orderTime = new Date(order.createdAt).toLocaleTimeString();
                    const itemsList = order.items.map(item => 
                        `${item.quantity}x ${item.name}${item.isFree ? ' (FREE)' : ''}${item.bonusUsed > 0 ? ` (${item.bonusUsed} points)` : ''}`
                    ).join(', ');
                    
                    let deliveryInfo = '';
                    if (order.delivery.enabled) {
                        if (order.delivery.type === 'classroom') {
                            deliveryInfo = `Delivery to: Classroom ${order.delivery.classroom}`;
                        } else {
                            deliveryInfo = `Delivery to: ${order.delivery.location}`;
                        }
                        if (order.delivery.isFree) {
                            deliveryInfo += ' (Free Delivery)';
                        }
                    } else {
                        deliveryInfo = 'Pickup';
                    }
                    
                    // УЛУЧШЕНО: Лучшее отображение статуса платежа и рефанда
                    let paymentStatusDisplay = '';
                    if (order.payment.method === 'card' && order.payment.isOnlinePayment) {
                        paymentStatusDisplay = 'Paid by Card';
                        
                        if (order.payment.status === 'refunded') {
                            paymentStatusDisplay += ' (REFUNDED)';
                        } else if (order.payment.status === 'refund_failed') {
                            paymentStatusDisplay += ' (REFUND FAILED - Contact Support)';
                        }
                    } else if (order.payment.total === 0) {
                        paymentStatusDisplay = 'Bonus Payment';
                    } else {
                        paymentStatusDisplay = 'Cash Payment';
                    }
                    
                    // Определяем, можно ли отменить заказ
                    const canCancel = ['pending','accepted','preparing','delivering'].includes(order.status);
                    
                    return `
                        <div class="order-card">
                            <div class="order-header">
                                <div>
                                    <h4>Order #${order.orderNumber}</h4>
                                    <p>${orderDate} at ${orderTime}</p>
                                    ${order.isBonusOrder ? '<span style="color: var(--bonus); font-weight: bold;">BONUS ORDER</span>' : ''}
                                </div>
                                <span class="order-status status-${order.status}">${order.status.toUpperCase()}</span>
                            </div>

                            <div class="order-items">
                                <strong>Items:</strong> ${itemsList}
                            </div>

                            <div style="margin: 10px 0;">
                                <strong>Delivery:</strong> ${deliveryInfo}
                            </div>

                            ${order.couponUsed && order.couponUsed.wasUsed ? `
                                <div style="margin: 10px 0; color: var(--success);">
                                    <strong>Coupon Applied:</strong> ${order.couponUsed.code}
                                    ${order.payment.discount > 0 ? ` (-$${order.payment.discount.toFixed(2)})` : ''}
                                </div>
                            ` : ''}

                            ${order.payment.bonusDiscount > 0 ? `
                                <div style="margin: 10px 0; color: var(--bonus);">
                                    <strong>Bonus Discount:</strong> -$${order.payment.bonusDiscount.toFixed(2)} (${order.payment.bonusPointsUsed} points used)
                                </div>
                            ` : ''}

                            <div class="order-footer">
                                <div>
                                    <strong>Total: $${order.payment.total.toFixed(2)}</strong>
                                    ${order.payment.bonusPointsEarned > 0 ? `<br><small>Earned ${order.payment.bonusPointsEarned} bonus points</small>` : ''}
                                </div>
                                <div style="text-align: right;">
                                    <small>${paymentStatusDisplay}</small>
                                    <br>
                                    <small>Status: ${order.payment.status}</small>
                                </div>
                            </div>

                            ${canCancel ? `
                                <button class="btn btn-danger" onclick="cancelUserOrder('${order._id}', ${order.payment.total || 0}, '${order.payment.transactionId || ''}')">
                                    Cancel order
                                </button>
                            ` : ''}
                            
                            ${order.payment.status === 'refund_failed' ? `
                                <div style="margin-top: 10px; padding: 10px; background: #fee; border-left: 4px solid #e74c3c; border-radius: 4px;">
                                    <strong style="color: #e74c3c;">Refund Issue:</strong> 
                                    <span style="color: #666;">Please contact support for assistance with your refund.</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
        } else {
            ordersList.innerHTML = '<p>Error loading orders</p>';
        }
    } catch (error) {
        console.error('Error loading orders:', error);
        ordersList.innerHTML = '<p>Error loading orders</p>';
    }
}

        // Cancel user order
        async function cancelUserOrder(orderId, amount, paymentId) {
    if (!confirm('Are you sure you want to cancel this order?')) return;

    // Показываем индикатор загрузки
    const cancelButton = event.target;
    const originalText = cancelButton.textContent;
    cancelButton.textContent = 'Cancelling...';
    cancelButton.disabled = true;

    try {
        const response = await fetch(`${API_URL}/orders/${orderId}/cancel`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (response.ok) {
            // Определяем тип сообщения на основе ответа сервера
            if (data.refundFailed) {
                if (data.contactSupport) {
                    showNotification('Order cancelled, but refund failed. Please contact support for assistance.', 'warning');
                } else {
                    showNotification('Order cancelled, but refund is being processed separately.', 'warning');
                }
            } else if (data.refundId) {
                showNotification(`Order cancelled and $${data.refundAmount} refund processed successfully!`, 'success');
            } else {
                showNotification('Order cancelled successfully!', 'success');
            }
            
            // Обновляем список заказов
            loadOrderHistory();
            
            // Обновляем профиль пользователя (для бонусных очков)
            if (currentUser && authToken) {
                await checkAuth();
            }
        } else {
            showNotification(data.error || 'Failed to cancel order', 'error');
            
            // Восстанавливаем кнопку
            cancelButton.textContent = originalText;
            cancelButton.disabled = false;
        }
    } catch (error) {
        console.error('Order cancellation error:', error);
        showNotification('Network error. Please check your connection and try again.', 'error');
        
        // Восстанавливаем кнопку
        cancelButton.textContent = originalText;
        cancelButton.disabled = false;
    }
}

function showEnhancedNotification(message, type = 'success', duration = 4000) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    // Добавляем иконки для разных типов
    let icon = '';
    switch(type) {
        case 'success':
            icon = '✓ ';
            break;
        case 'error':
            icon = '✗ ';
            break;
        case 'warning':
            icon = '⚠ ';
            break;
        case 'bonus':
            icon = '⭐ ';
            break;
    }
    
    notification.innerHTML = icon + message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, duration);
}

async function checkRefundStatus(orderId) {
    try {
        const response = await fetch(`${API_URL}/orders/my-orders`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const orders = await response.json();
            const order = orders.find(o => o._id === orderId);
            
            if (order && order.payment.status === 'refund_failed') {
                showNotification('Refund processing failed for this order. Please contact support.', 'warning');
                return false;
            } else if (order && order.payment.status === 'refunded') {
                showNotification('Refund was processed successfully.', 'success');
                return true;
            }
        }
    } catch (error) {
        console.error('Error checking refund status:', error);
    }
    return null;
}

        // Checkout functions
        function proceedToCheckout() {
            if (cart.length === 0) {
                showNotification('Your cart is empty!', 'error');
                return;
            }
            
            showSection('checkout');
            
            document.getElementById('enableDelivery').checked = isDeliveryEnabled;
            toggleDelivery();
            
            if (currentUser) {
                fillCheckoutUserData();
                document.getElementById('guestOption').style.display = 'none';
            } else {
                document.getElementById('guestOption').style.display = 'block';
            }
        }

        function fillCheckoutUserData() {
            if (currentUser) {
                document.getElementById('customerName').value = currentUser.name || '';
                document.getElementById('customerEmail').value = currentUser.email || '';
                document.getElementById('customerPhone').value = currentUser.phone || '';
            }
        }

        function continueAsGuest() {
            document.querySelector('.guest-checkout-option').style.display = 'none';
        }

        function toggleDeliveryFields() {
            const deliveryType = document.getElementById('deliveryType').value;
            document.getElementById('classroomField').style.display = deliveryType === 'classroom' ? 'block' : 'none';
            document.getElementById('locationField').style.display = deliveryType === 'location' ? 'block' : 'none';
        }


// Enhanced checkout form submission
document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (isPaymentProcessing) {
        showNotification('Payment is already being processed, please wait...', 'warning');
        return;
    }
    
    const submitButton = e.target.querySelector('button[type="submit"]');
    const submitButtonText = document.getElementById('submitButtonText');
    const submitLoading = document.getElementById('submitLoading');
    
    // Устанавливаем флаг обработки
    isPaymentProcessing = true;
    
    submitButton.disabled = true;
    submitButtonText.style.display = 'none';
    submitLoading.style.display = 'inline-block';
    
    try {
        const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        
        // Если выбрана карточная оплата - используем Square
        if (selectedPaymentMethod === 'card') {
            await processSquarePaymentIntegrated();
        } else {
            // Обычная обработка для других методов оплаты
            await processRegularOrder();
        }
        
    } catch (error) {
        console.error('Order submission failed:', error);
        showNotification(error.message || 'Order failed. Please try again.', 'error');
    } finally {
        isPaymentProcessing = false;
        submitButton.disabled = false;
        submitButtonText.style.display = 'inline';
        submitLoading.style.display = 'none';
    }
});

        // Receipt functions
function showReceipt(orderData) {
    const modal = document.getElementById('receiptModal');
    
    document.getElementById('receiptOrderNumber').textContent = `Order #${orderData.orderNumber}`;
    document.getElementById('receiptTimestamp').textContent = new Date().toLocaleString();
    
    document.getElementById('receiptCustomerName').textContent = orderData.customer.name;
    document.getElementById('receiptCustomerPhone').textContent = orderData.customer.phone;
    document.getElementById('receiptCustomerEmail').textContent = orderData.customer.email;
    
    const itemsHtml = orderData.items.map(item => `
        <div class="receipt-item">
            <span>${item.quantity}x ${item.name}</span>
            <span>${(item.price * item.quantity).toFixed(2)}</span>
        </div>
    `).join('');
    document.getElementById('receiptItems').innerHTML = itemsHtml;
    
    // ИСПРАВИТЬ: проверить существование элемента перед обращением к style
    const deliverySection = document.getElementById('receiptDeliverySection');
    const deliveryInfo = document.getElementById('receiptDeliveryInfo');
    
    if (deliverySection && deliveryInfo) { // ДОБАВИТЬ ПРОВЕРКУ
        if (orderData.delivery && orderData.delivery.enabled) {
            deliverySection.style.display = 'block';
            let deliveryText = orderData.delivery.type === 'classroom' ? 
                `Classroom ${orderData.delivery.classroom}` : 
                orderData.delivery.location;
            deliveryInfo.textContent = `Delivery to: ${deliveryText}`;
        } else {
            deliverySection.style.display = 'block';
            deliveryInfo.textContent = 'Pickup at Snack Shack';
        }
    }
    
    const totals = orderData.totals;
    document.getElementById('receiptSubtotal').textContent = `${totals.subtotal.toFixed(2)}`;
    
    // ИСПРАВИТЬ: добавить проверки для всех элементов
    const deliveryFeeRow = document.getElementById('receiptDeliveryFeeRow');
    if (deliveryFeeRow && totals.deliveryFee > 0) {
        deliveryFeeRow.style.display = 'flex';
        document.getElementById('receiptDeliveryFee').textContent = `${totals.deliveryFee.toFixed(2)}`;
    }
    
    const discountRow = document.getElementById('receiptDiscountRow');
    if (discountRow && totals.discount > 0) {
        discountRow.style.display = 'flex';
        document.getElementById('receiptDiscount').textContent = `-${totals.discount.toFixed(2)}`;
    }
    
    const bonusRow = document.getElementById('receiptBonusRow');
    if (bonusRow && totals.bonusDiscount > 0) {
        bonusRow.style.display = 'flex';
        document.getElementById('receiptBonusDiscount').textContent = `-${totals.bonusDiscount.toFixed(2)}`;
    }

    // ИСПРАВИТЬ: проверить service fee элемент
    const serviceFeeRow = document.getElementById('receiptServiceFeeRow');
    if (serviceFeeRow && totals.serviceFee > 0) {
        serviceFeeRow.style.display = 'flex';
        document.getElementById('receiptServiceFee').textContent = `${totals.serviceFee.toFixed(2)}`;
    }
    
    document.getElementById('receiptTotal').textContent = `${totals.total.toFixed(2)}`;
    document.getElementById('receiptPaymentMethod').textContent = 
        orderData.paymentMethod === 'card' ? 'Credit/Debit Card' :
        orderData.paymentMethod === 'bonus' ? 'Bonus Points' : 
        'Cash on Delivery';
    
    const bonusEarnedRow = document.getElementById('receiptBonusEarnedRow');
    if (bonusEarnedRow && totals.bonusPointsToEarn > 0) {
        bonusEarnedRow.style.display = 'flex';
        document.getElementById('receiptBonusEarned').textContent = `${totals.bonusPointsToEarn} points`;
    }
    
    lastReceipt = orderData;
    
    if (!currentUser) {
        saveReceiptToLocalStorage(orderData);
    }
    
    modal.classList.add('active');
}

        function closeReceipt() {
            document.getElementById('receiptModal').classList.remove('active');
        }

        function printReceipt() {
            window.print();
        }

        function downloadReceipt() {
            if (!lastReceipt) return;
            
            const receiptContent = document.querySelector('.receipt-container').innerHTML;
            const blob = new Blob([`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Receipt - Order #${lastReceipt.orderNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        .receipt-header { background: #79191b; color: white; padding: 20px; text-align: center; }
                        .receipt-section { margin: 20px 0; }
                        .receipt-row { display: flex; justify-content: space-between; margin: 10px 0; }
                        .total { font-weight: bold; font-size: 18px; border-top: 2px solid #79191b; padding-top: 10px; }
                    </style>
                </head>
                <body>${receiptContent}</body>
                </html>
            `], { type: 'text/html' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receipt-${lastReceipt.orderNumber}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveReceiptToLocalStorage(orderData) {
            let savedReceipts = JSON.parse(localStorage.getItem('savedReceipts') || '[]');
            savedReceipts.push({
                ...orderData,
                timestamp: new Date().toISOString()
            });
            
            if (savedReceipts.length > 20) {
                savedReceipts = savedReceipts.slice(-20);
            }
            
            localStorage.setItem('savedReceipts', JSON.stringify(savedReceipts));
            updateSavedReceiptsCount();
        }

        function updateSavedReceiptsCount() {
            const savedReceipts = JSON.parse(localStorage.getItem('savedReceipts') || '[]');
            const badge = document.getElementById('savedReceiptsCount');
            
            if (savedReceipts.length > 0) {
                badge.style.display = 'flex';
                badge.textContent = savedReceipts.length;
            } else {
                badge.style.display = 'none';
            }
        }

        function viewSavedReceipts() {
            const savedReceipts = JSON.parse(localStorage.getItem('savedReceipts') || '[]');
            
            if (savedReceipts.length === 0) {
                showNotification('No saved receipts found', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Saved Receipts</h2>
                        <span class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">×</span>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${savedReceipts.map((receipt, index) => `
                            <div style="padding: 15px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; cursor: pointer;"
                                 onclick='showSavedReceipt(${JSON.stringify(receipt).replace(/'/g, "\\'")})'>
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>Order #${receipt.orderNumber}</strong>
                                    <span style="color: #666;">${new Date(receipt.timestamp).toLocaleDateString()}</span>
                                </div>
                                <div style="margin-top: 5px; color: #666;">
                                    Total: ${receipt.totals.total.toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="clearSavedReceipts()">Clear All Receipts</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showSavedReceipt(receipt) {
            document.querySelector('.modal').remove();
            showReceipt(receipt);
        }

        function clearSavedReceipts() {
            if (confirm('Are you sure you want to clear all saved receipts?')) {
                localStorage.removeItem('savedReceipts');
                updateSavedReceiptsCount();
                document.querySelector('.modal').remove();
                showNotification('All receipts cleared', 'success');
            }
        }

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', async () => {
    showDailyVerse();
    updateFavoritesCount();
    updateSavedReceiptsCount();
    
    // ✅ ОБНОВЛЕНО: Проверка авторизации и доступа к доставке
    await checkAuth();
    
    // ✅ ДОБАВЛЕНО: Проверка доступа к доставке для авторизованных пользователей
    if (currentUser && authToken) {
        await checkDeliveryAccess();
    }
    
    loadProducts();
    loadCart();
    loadDeals();
    
    // ВАЖНО: Устанавливаем метод оплаты по умолчанию ПЕРЕД инициализацией Square
    selectPaymentMethod('cod');
    
    // Инициализируем Square с задержкой
    setTimeout(() => {
        checkAndInitializeSquare();
    }, 1000);
    
    // Остальная инициализация...
    setTimeout(() => {
        ['searchInput', 'loginEmail', 'loginPassword', 'registerEmail', 'registerPassword'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (id.includes('Password'))
                    el.setAttribute('autocomplete', 'new-password');
                else
                    el.setAttribute('autocomplete', 'off');
            }
        });
    }, 100);

    // ✅ ОБНОВЛЕНО: Проверка доступа к доставке с учетом индивидуальных настроек
    try {
        const res = await fetch(`${API_URL}/public/delivery`);
        const data = await res.json();
        const deliveryBlock = document.querySelector('.checkbox-group');
        
        if (deliveryBlock) {
            // Если глобальная доставка отключена, проверяем индивидуальный доступ
            if (!data.deliveryEnabled) {
                if (currentUser && authToken) {
                    const accessRes = await fetch(`${API_URL}/user/delivery-status`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const accessData = await accessRes.json();
                    
                    // Показываем блок доставки только если есть индивидуальный доступ
                    if (!accessData.hasDeliveryAccess) {
                        deliveryBlock.classList.add('hidden');
                    }
                } else {
                    // Для неавторизованных пользователей скрываем
                    deliveryBlock.classList.add('hidden');
                }
            }
        }
    } catch (err) {
        console.error('Delivery status check failed:', err);
    }
});


// Scroll to top functionality
        window.addEventListener('scroll', () => {
            const scrollBtn = document.getElementById('scrollTopBtn');
            if (window.pageYOffset > 300) {
                scrollBtn.style.display = 'block';
            } else {
                scrollBtn.style.display = 'none';
            }
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
// --- Special Deals Functions ---
let allDeals = [];

async function loadDeals() {
    try {
        const response = await fetch(`${API_URL}/deals`);
        if (response.ok) {
            allDeals = await response.json();
            displayDeals(allDeals);
        }
    } catch (error) {
        console.error('Error loading deals:', error);
    }
}

function displayDeals(deals) {
    const dealsSection = document.getElementById('dealsSection');
    const dealsGrid = document.getElementById('dealsGrid');
    
    if (!deals || deals.length === 0) {
        dealsSection.style.display = 'none';
        return;
    }
    
    dealsSection.style.display = 'block';
    
    dealsGrid.innerHTML = deals.map(deal => {
        const imageContent = deal.image ? 
            `<img src="${deal.image}" alt="${deal.name}">` : 
            '🎁';
        
        const productsList = deal.products.map(p => 
            `<li>${p.quantity}x ${p.productId?.name || 'Unknown'}</li>`
        ).join('');
        
        return `
            <div class="deal-card">
                <div class="deal-image">${imageContent}</div>
                <div class="deal-info">
                    <div class="deal-name">${deal.name}</div>
                    ${deal.description ? `<div class="deal-description">${deal.description}</div>` : ''}
                    
                    <div class="deal-products">
                        <h4>📦 Includes:</h4>
                        <ul>${productsList}</ul>
                    </div>
                    
                    <div class="deal-pricing">
                        <div>
                            <div class="deal-original-price">$${deal.originalPrice?.toFixed(2) || '0.00'}</div>
                            <div class="deal-price">$${deal.dealPrice.toFixed(2)}</div>
                        </div>
                        <div class="deal-savings">
                            Save $${deal.savings?.toFixed(2) || '0.00'} (${deal.savingsPercent || 0}%)
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="addDealToCart('${deal._id}')" style="width: 100%;">
                        Add Deal to Cart 🔥
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function addDealToCart(dealId) {
    const deal = allDeals.find(d => d._id === dealId);
    if (!deal) return;
    
    // Вычисляем пропорциональную цену для каждого товара в комбо
    const proportionalPrice = (deal.dealPrice / deal.products.length);
    
    deal.products.forEach(item => {
        const product = products.find(p => p._id === item.productId._id);
        if (product) {
            for (let i = 0; i < item.quantity; i++) {
                cart.push({
                    ...product,
                    price: proportionalPrice,
                    quantity: 1,
                    fromDeal: true,
                    dealId: dealId,        // ✅ КРИТИЧЕСКИ ВАЖНО!
                    dealName: deal.name
                });
            }
        }
    });
    
    saveCart();
    updateCartUI();
    showNotification(`${deal.name} added to cart! 🔥`, 'success');
}


    </script>

<script>
// Simple error tracking
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
});
</script>
<button class="scroll-to-top" onclick="scrollToTop()" id="scrollTopBtn" style="display: none;">
  ↑
</button>
<!-- Variation Selection Modal -->
<div class="modal" id="variationModal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close-modal" onclick="closeVariationModal()">&times;</span>
        <h2 id="variationModalTitle">Select Option</h2>
        
        <div id="variationProductInfo" style="text-align: center; margin-bottom: 20px;">
            <!-- Product info will be inserted here -->
        </div>
        
        <div id="variationOptions" style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Variations will be inserted here -->
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
            <button class="btn btn-secondary" onclick="closeVariationModal()">Cancel</button>
        </div>
    </div>
</div>
</body>
</html> 
